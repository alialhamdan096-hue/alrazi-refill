<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alrazi Refill Cash Patients System</title>
    
    <link rel="icon" href="logo.jpeg" type="image/jpeg">
    <link rel="shortcut icon" href="logo.jpeg" type="image/jpeg">

    <style>
        /* ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        :root {
            --primary: #561C2C; /* Ø§Ù„Ø¹Ù†Ø§Ø¨ÙŠ */
            --primary-light: #7a2840;
            --accent: #8DC63F; /* Ø§Ù„Ø£Ø®Ø¶Ø± */
            --accent-dark: #6fa329;
            --bg-light: #fdfcfc;
            --text-dark: #333;
            --gray: #666;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* --- Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§ --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            /* ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ background: white Ø¨ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ø¨Ù†ÙŠ Ø¯Ø§ÙØ¦ ÙˆÙØ§ØªØ­ */
            background: linear-gradient(180deg, #f9f6f2 0%, #e8dccf 100%);
            color: var(--text-dark); 
            min-height: 100vh; 
            padding: 20px; 
        }
        /* --------------------------- */

        .container { max-width: 1200px; margin: 0 auto; }
        
        .header-container { text-align: center; margin-bottom: 25px; }
        .logo-img { height: 80px; margin-bottom: 10px; } 
        h1 { color: var(--primary); margin-bottom: 10px; font-weight: 700; text-shadow: 1px 1px 2px rgba(255,255,255,0.5); }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        /* ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .tab { background: rgba(255, 255, 255, 0.7); border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-weight: bold; color: var(--gray); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(86, 28, 44, 0.3); }
        .tab:hover:not(.active) { background: white; }
        
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¢Ù† Ø³ØªØ¨Ø±Ø² Ø£ÙƒØ«Ø± Ø¨ÙØ¶Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .card { background: #fff; border-radius: 16px; padding: 25px; border: none; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-size: 14px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; color: #333; font-size: 14px; transition: 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(86, 28, 44, 0.1); background: white; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 8px 16px; width: auto; margin: 0; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        th { text-align: left; padding: 15px; background: #f9f9f9; color: var(--gray); font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #fcfcfc; }
        .name { font-weight: bold; color: var(--primary); }
        .phone { color: #888; font-size: 13px; margin-top: 2px; }
        .med { color: var(--primary); font-weight: 500; }
        
        .badge { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.5px; }
        .badge-ok { background: rgba(141, 198, 63, 0.15); color: var(--accent-dark); }
        .badge-warn { background: rgba(245,158,11,0.15); color: #d97706; }
        .badge-danger { background: rgba(239,68,68,0.15); color: #dc2626; }
        
        .actions { display: flex; gap: 8px; }
        .actions button { width: 36px; height: 36px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .wa { background: #25D366; color: white; }
        .edit { background: rgba(86, 28, 44, 0.1); color: var(--primary); }
        .del { background: rgba(239,68,68,0.1); color: #ef4444; }
        .actions button:hover { transform: translateY(-2px); }
        
        .empty { text-align: center; padding: 50px; color: #aaa; font-style: italic; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat { background: white; padding: 20px; border-radius: 12px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .stat::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--gray); }
        .stat-num { font-size: 32px; font-weight: 800; color: var(--text-dark); }
        .stat-label { color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }
        
        .stat.total::after { background: var(--primary); }
        .stat.w::after { background: #f59e0b; }
        .stat.d::after { background: #ef4444; }
        .stat.s::after { background: var(--accent); }
        
        .sync { text-align: center; padding: 8px; font-size: 13px; margin-bottom: 15px; border-radius: 8px; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); }
        .sync-ok { color: var(--accent-dark); border: 1px solid rgba(141, 198, 63, 0.3); }
        .sync-err { color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        
        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .track-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .track-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .track-card.converted { border-color: var(--accent); background: rgba(141, 198, 63, 0.05); }
        
        .track-card .name { font-size: 16px; margin-bottom: 5px; color: #333; }
        .track-card .med { margin: 10px 0; color: var(--primary); font-size: 14px; }
        .track-card .info { font-size: 12px; color: #888; margin-bottom: 15px; line-height: 1.5; }
        
        .track-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; background: rgba(141, 198, 63, 0.15); color: var(--accent-dark); transition: 0.2s; }
        .track-btn:hover { background: var(--accent); color: white; }
        .track-btn.done { background: var(--accent); color: white; }
        
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .report-card { background: #fff; border-radius: 12px; padding: 25px; border: none; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .report-value { font-size: 48px; font-weight: bold; color: var(--primary); }
        .report-label { font-size: 14px; color: #888; margin-top: 5px; }
        .progress { height: 10px; background: #eee; border-radius: 6px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 6px; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <img src="logo.jpeg" alt="Alrazi Pharmacy" class="logo-img" onerror="this.style.display='none'"> 
            <h1>Alrazi Refill Cash Patients System</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showPage('patients')">ğŸ“‹ Patients</button>
            <button class="tab" onclick="showPage('tracking')">ğŸ“Š Tracking</button>
            <button class="tab" onclick="showPage('reports')">ğŸ“ˆ Reports</button>
        </div>
        
        <div id="sync" class="sync sync-ok">âœ“ Connected to Google Sheets</div>

        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Total Patients</div></div>
                <div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Need Reminder</div></div>
                <div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Overdue</div></div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom:20px; color:var(--primary);" id="formTitle">Add Patient</h3>
                    <form id="form">
                        <input type="hidden" id="pid">
                        <div class="form-group"><label>Patient Name (Optional)</label><input type="text" id="name"></div>
                        <div class="form-group"><label>Phone (e.g. 966512345678)</label><input type="tel" id="phone" required></div>
                        <div class="form-group"><label>Medication</label><input type="text" id="med" required></div>
                        <div class="row">
                            <div class="form-group"><label>Dispense Date</label><input type="date" id="date" required></div>
                            <div class="form-group"><label>Duration (days)</label><input type="number" id="days" value="30" required></div>
                        </div>
                        <div class="form-group"><label>Notes</label><input type="text" id="notes"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Add Patient</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <div class="header-row">
                        <h3 style="color:var(--primary);">Patient Records</h3>
                    </div>
                    <input type="text" id="search" placeholder="ğŸ” Search patient, med or phone..." oninput="renderPatients()" style="margin-bottom: 15px;">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Patient</th><th>Medication</th><th>Refill Date</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="trackingPage" class="page">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">Reminders Sent</div></div>
                <div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">Converted</div></div>
                <div class="stat" style="border-left: 4px solid var(--primary);"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Conversion Rate</div></div>
            </div>

            <div class="card">
                <div class="header-row">
                    <h3 style="color:var(--primary);">ğŸ“Š Track Conversions</h3>
                    <select id="trackFilter" onchange="renderTracking()" style="width: auto; min-width: 150px;">
                        <option value="all">All Sent</option>
                        <option value="waiting">â³ Waiting</option>
                        <option value="converted">âœ… Converted</option>
                    </select>
                </div>
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <div id="reportsPage" class="page">
            <div class="card">
                <div class="header-row">
                    <h3 style="color:var(--primary);">ğŸ“ˆ Monthly Report</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="reportMonth" onchange="genReport()" style="width: auto;">
                            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                        </select>
                        <select id="reportYear" onchange="genReport()" style="width: auto;">
                            <option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print</button>
                    </div>
                </div>
            </div>
            
            <div class="report-grid">
                <div class="report-card">
                    <div class="report-value" id="rSent">0</div>
                    <div class="report-label">ğŸ“¤ Reminders Sent</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: var(--accent);" id="rConverted">0</div>
                    <div class="report-label">âœ… Converted</div>
                </div>
                <div class="report-card">
                    <div class="report-value" style="color: #3b82f6;" id="rRate">0%</div>
                    <div class="report-label">ğŸ“Š Conversion Rate</div>
                    <div class="progress"><div class="progress-bar" id="rBar" style="width:0%; background:var(--accent);"></div></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color:var(--primary);">ğŸ“‹ Summary</h3>
                <table>
                    <thead><tr><th>Metric</th><th>Count</th><th>Percentage</th></tr></thead>
                    <tbody id="summaryTb"></tbody>
                </table>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color:var(--primary);">âœ… Converted Patients</h3>
                <table>
                    <thead><tr><th>Patient</th><th>Phone</th><th>Medication</th><th>Reminder Date</th><th>Converted Date</th></tr></thead>
                    <tbody id="convList"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyLnOK9PXLM7Z6_ERgT84nul50S62juQ7h8AYywUUJ0eUUn1GaG_0LOjkY7HLw9S7wYkQ/exec';
let patients = [];
let editId = null;

document.getElementById('reportMonth').value = new Date().getMonth();
document.getElementById('reportYear').value = new Date().getFullYear();
document.getElementById('date').valueAsDate = new Date();

loadData();

function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.getElementById(p + 'Page').classList.add('active');
    event.target.classList.add('active');
    if (p === 'tracking') renderTracking();
    if (p === 'reports') genReport();
}

async function loadData() {
    document.getElementById('patientsTbody').innerHTML = '<tr><td colspan="5"><div class="empty">Loading data...</div></td></tr>';
    try {
        const res = await fetch(API + '?action=get');
        const data = await res.json();
        patients = data.map(p => ({
            id: String(p.id || ''),
            name: p.name || '',
            phone: String(p.phone || ''),
            med: p.med || '',
            date: fmtDate(p.date),
            days: String(p.days || '30'),
            notes: p.notes || '',
            reminderSent: p.reminderSent || 'no',
            reminderDate: fmtDate(p.reminderDate),
            converted: p.converted || 'no',
            convertedDate: fmtDate(p.convertedDate)
        }));
        syncStatus(true);
        renderPatients();
    } catch (e) {
        syncStatus(false);
        patients = JSON.parse(localStorage.getItem('patients')) || [];
        renderPatients();
    }
}

function fmtDate(v) {
    if (!v) return '';
    if (typeof v === 'string' && v.match(/^\d{4}-\d{2}-\d{2}$/)) return v;
    const d = new Date(v);
    if (isNaN(d)) return v;
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function syncStatus(ok) {
    const el = document.getElementById('sync');
    el.className = ok ? 'sync sync-ok' : 'sync sync-err';
    el.textContent = ok ? 'âœ“ Connected to Google Sheets' : 'âš  Offline Mode - Changes saved locally';
}

document.getElementById('form').onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';
    
    const p = {
        id: editId || Date.now().toString(),
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value.replace(/\D/g, ''),
        med: document.getElementById('med').value,
        date: document.getElementById('date').value,
        days: document.getElementById('days').value,
        notes: document.getElementById('notes').value,
        reminderSent: 'no', reminderDate: '', converted: 'no', convertedDate: ''
    };
    
    if (editId) {
        const old = patients.find(x => x.id === editId);
        p.reminderSent = old.reminderSent; p.reminderDate = old.reminderDate;
        p.converted = old.converted; p.convertedDate = old.convertedDate;
    }
    
    try {
        await fetch(API + '?action=' + (editId ? 'update' : 'add') + '&data=' + encodeURIComponent(JSON.stringify(p)));
        if (editId) patients[patients.findIndex(x => x.id === editId)] = p;
        else patients.push(p);
        localStorage.setItem('patients', JSON.stringify(patients));
        syncStatus(true);
    } catch (e) {
        if (editId) patients[patients.findIndex(x => x.id === editId)] = p;
        else patients.push(p);
        localStorage.setItem('patients', JSON.stringify(patients));
        syncStatus(false);
    }
    
    renderPatients(); resetForm();
    btn.disabled = false; btn.textContent = 'Add Patient';
};

function resetForm() {
    editId = null;
    document.getElementById('form').reset();
    document.getElementById('days').value = '30';
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('formTitle').textContent = 'Add Patient';
    document.getElementById('submitBtn').textContent = 'Add Patient';
}

function editP(id) {
    const p = patients.find(x => x.id === id);
    editId = id;
    document.getElementById('name').value = p.name;
    document.getElementById('phone').value = p.phone;
    document.getElementById('med').value = p.med;
    document.getElementById('date').value = p.date;
    document.getElementById('days').value = p.days;
    document.getElementById('notes').value = p.notes || '';
    document.getElementById('formTitle').textContent = 'Edit Patient';
    document.getElementById('submitBtn').textContent = 'Update';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function delP(id) {
    if (confirm('Delete this patient?')) {
        try { await fetch(API + '?action=delete&id=' + id); } catch (e) {}
        patients = patients.filter(x => x.id !== id);
        localStorage.setItem('patients', JSON.stringify(patients));
        renderPatients();
    }
}

function sendWA(id) {
    const p = patients.find(x => x.id === id);
    const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡
ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ ØªØ±Ø­Ø¨ Ø¨ÙƒÙ…

Ù‡Ø°Ø§ ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:

Ø§Ù„Ø¯ÙˆØ§Ø¡: ${p.med}

Ù†Ø³Ø¹Ø¯ Ø¨ØªØ¬Ù‡ÙŠØ²Ù‡ Ù„ÙƒÙ… Ø¹Ø¨Ø±:

- Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©

- Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…ÙˆÙ‚Ø¹ÙƒÙ…

Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©:
https://shorturl.at/M2Cq3

Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ©`;
    window.open('https://wa.me/' + p.phone + '?text=' + encodeURIComponent(msg), '_blank');
    p.reminderSent = 'yes';
    const today = new Date();
    p.reminderDate = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
    saveP(p);
}

async function saveP(p) {
    try { await fetch(API + '?action=update&data=' + encodeURIComponent(JSON.stringify(p))); } catch (e) {}
    localStorage.setItem('patients', JSON.stringify(patients));
    renderPatients(); renderTracking();
}

async function markConverted(id) {
    const p = patients.find(x => x.id === id);
    p.converted = 'yes';
    const today = new Date();
    p.convertedDate = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
    await saveP(p);
}

async function undoConverted(id) {
    const p = patients.find(x => x.id === id);
    p.converted = 'no';
    p.convertedDate = '';
    await saveP(p);
}

function getRefill(p) {
    const d = new Date(p.date);
    d.setDate(d.getDate() + parseInt(p.days));
    return d;
}

function getDays(p) {
    const today = new Date(); today.setHours(0,0,0,0);
    const refill = getRefill(p); refill.setHours(0,0,0,0);
    return Math.ceil((refill - today) / (1000*60*60*24));
}

function renderPatients() {
    const search = document.getElementById('search').value.toLowerCase();
    let list = patients.filter(p => p.name.toLowerCase().includes(search) || p.med.toLowerCase().includes(search) || p.phone.includes(search));
    list.sort((a,b) => getRefill(a) - getRefill(b));
    
    let w=0, o=0;
    patients.forEach(p => { const d = getDays(p); if (d < 0) o++; else if (d <= 2) w++; });
    document.getElementById('total').textContent = patients.length;
    document.getElementById('warn').textContent = w;
    document.getElementById('over').textContent = o;

    const tbody = document.getElementById('patientsTbody');
    if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty">No patients found</div></td></tr>'; return; }
    
    tbody.innerHTML = list.map(p => {
        const d = getDays(p);
        const refill = getRefill(p).toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
        let st, sc;
        if (d < 0) { st = 'Overdue ' + Math.abs(d) + 'd'; sc = 'danger'; }
        else if (d <= 2) { st = d + 'd left'; sc = 'warn'; }
        else { st = d + 'd left'; sc = 'ok'; }
        
        return `<tr>
            <td><div class="name">${p.name}</div><div class="phone">${p.phone}</div></td>
            <td><div class="med">${p.med}</div>${p.notes ? '<div class="phone">'+p.notes+'</div>' : ''}</td>
            <td>${refill}</td>
            <td><span class="badge badge-${sc}">${st}</span></td>
            <td><div class="actions">
                <button class="wa" onclick="sendWA('${p.id}')" title="WhatsApp">ğŸ“±</button>
                <button class="edit" onclick="editP('${p.id}')" title="Edit">âœï¸</button>
                <button class="del" onclick="delP('${p.id}')" title="Delete">ğŸ—‘ï¸</button>
            </div></td>
        </tr>`;
    }).join('');
}

function renderTracking() {
    const filter = document.getElementById('trackFilter').value;
    let list = patients.filter(p => p.reminderSent === 'yes');
    if (filter === 'waiting') list = list.filter(p => p.converted !== 'yes');
    else if (filter === 'converted') list = list.filter(p => p.converted === 'yes');
    list.sort((a,b) => new Date(b.reminderDate) - new Date(a.reminderDate));
    
    const sent = patients.filter(p => p.reminderSent === 'yes').length;
    const conv = patients.filter(p => p.converted === 'yes').length;
    document.getElementById('tSent').textContent = sent;
    document.getElementById('tConverted').textContent = conv;
    document.getElementById('tRate').textContent = sent > 0 ? Math.round(conv/sent*100) + '%' : '0%';
    
    const grid = document.getElementById('trackGrid');
    if (list.length === 0) { grid.innerHTML = '<div class="empty" style="grid-column:1/-1;">No records found</div>'; return; }
    
    grid.innerHTML = list.map(p => `
        <div class="track-card ${p.converted === 'yes' ? 'converted' : ''}">
            <div class="name">${p.name}</div>
            <div class="phone">${p.phone}</div>
            <div class="med">${p.med}</div>
            <div class="info">ğŸ“¤ Sent: ${p.reminderDate}${p.converted === 'yes' ? '<br>âœ… Converted: ' + p.convertedDate : ''}</div>
            ${p.converted === 'yes' ? `<button class="track-btn done" onclick="undoConverted('${p.id}')">âœ… Converted (Click to Undo)</button>` : `<button class="track-btn" onclick="markConverted('${p.id}')">âœ… Mark as Converted</button>`}
        </div>
    `).join('');
}

function genReport() {
    const m = parseInt(document.getElementById('reportMonth').value);
    const y = parseInt(document.getElementById('reportYear').value);
    
    const mp = patients.filter(p => {
        if (p.reminderSent !== 'yes') return false;
        const rd = new Date(p.reminderDate);
        return rd.getMonth() === m && rd.getFullYear() === y;
    });
    
    const sent = mp.length;
    const conv = mp.filter(p => p.converted === 'yes').length;
    const rate = sent > 0 ? Math.round(conv/sent*100) : 0;
    
    document.getElementById('rSent').textContent = sent;
    document.getElementById('rConverted').textContent = conv;
    document.getElementById('rRate').textContent = rate + '%';
    document.getElementById('rBar').style.width = rate + '%';
    
    document.getElementById('summaryTb').innerHTML = `
        <tr><td>ğŸ“¤ Reminders Sent</td><td>${sent}</td><td>100%</td></tr>
        <tr><td>âœ… Converted</td><td>${conv}</td><td>${rate}%</td></tr>
        <tr><td>â³ Waiting</td><td>${sent - conv}</td><td>${sent > 0 ? Math.round((sent-conv)/sent*100) : 0}%</td></tr>
    `;
    
    const convP = mp.filter(p => p.converted === 'yes');
    document.getElementById('convList').innerHTML = convP.length > 0 
        ? convP.map(p => `<tr><td class="name">${p.name}</td><td class="phone">${p.phone}</td><td class="med">${p.med}</td><td>${p.reminderDate}</td><td>${p.convertedDate}</td></tr>`).join('')
        : '<tr><td colspan="5"><div class="empty">No conversions this month</div></td></tr>';
}
</script>
</body>
</html>
