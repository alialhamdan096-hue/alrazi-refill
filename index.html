<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 1 Pharmacy System</title>
    <style>
        /* ŸÜŸÅÿ≥ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ£ÿµŸÑŸä ÿ®ÿßŸÑÿ∂ÿ®ÿ∑ (ÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿ±ÿßÿ≤Ÿä) */
        :root{--primary:#561C2C;--primary-light:#7a2840;--accent:#8DC63F;--text-dark:#333;--gray:#666;--bg:#f4f4f9;--white:#fff;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--radius:12px;--shadow:0 4px 15px rgba(0,0,0,0.05);}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(180deg,#f9f6f2 0%,#e8dccf 100%);color:var(--text-dark);min-height:100vh;padding:20px}
        
        /* Layout */
        .container{max-width:1000px;margin:0 auto}
        .header{text-align:center;margin-bottom:25px}
        h1{color:var(--primary);font-weight:800;font-size:28px;margin-bottom:5px}
        
        /* Navigation Tabs */
        .tabs{display:flex;justify-content:center;gap:10px;margin-bottom:20px}
        .tab{background:rgba(255,255,255,0.6);border:none;padding:12px 25px;border-radius:50px;font-weight:bold;color:var(--gray);cursor:pointer;transition:0.3s}
        .tab.active{background:var(--primary);color:white;box-shadow:0 5px 15px rgba(86,28,44,0.3)}
        
        /* Cards */
        .card{background:white;border-radius:var(--radius);padding:25px;margin-bottom:20px;box-shadow:var(--shadow)}
        .page{display:none;animation:fadeIn 0.3s}.page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Form Elements */
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;font-weight:bold;font-size:13px;color:#555}
        input,select{width:100%;padding:12px;border:2px solid #eee;border-radius:8px;font-size:15px;transition:0.3s}
        input:focus,select:focus{border-color:var(--primary);outline:none}
        
        .btn{width:100%;padding:12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;transition:0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover{background:var(--primary-light)}
        
        /* Type Selector */
        .type-selector{display:flex;gap:10px;margin-bottom:20px}
        .type-btn{flex:1;padding:15px;border:2px solid #eee;border-radius:10px;background:white;cursor:pointer;text-align:center;font-weight:bold;color:#666}
        .type-btn.active{border-color:var(--primary);background:#fcf1f3;color:var(--primary)}

        /* Stats & Tables */
        .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
        .stat{background:white;padding:15px;border-radius:10px;text-align:center;box-shadow:var(--shadow);border-bottom:3px solid #eee}
        .stat-num{font-size:24px;font-weight:bold;color:var(--primary)}
        .stat-lbl{font-size:11px;color:#888}

        table{width:100%;border-collapse:collapse;margin-top:10px}
        th{text-align:left;padding:10px;color:#666;font-size:12px;border-bottom:2px solid #eee}
        td{padding:12px 10px;border-bottom:1px solid #eee}
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:bold}
        .b-ok{background:#dcfce7;color:#166534}
        .b-warn{background:#fef3c7;color:#92400e}
        .b-bad{background:#fee2e2;color:#991b1b}
        .b-ord{background:#dbeafe;color:#1e40af}

        /* Actions */
        .actions{display:flex;gap:5px}
        .actions button{width:32px;height:32px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .btn-wa{background:#25D366;color:white}
        .btn-edit{background:#f3f4f6}
        .btn-del{background:#fee2e2;color:red}

        /* Loading & Toast */
        #loader{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);z-index:999;display:none;flex-direction:column;align-items:center;justify-content:center}
        .spinner{width:40px;height:40px;border:4px solid #eee;border-top-color:var(--primary);border-radius:50%;animation:spin 1s infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:10px 20px;border-radius:20px;font-size:14px;display:none;z-index:1000}
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p style="margin-top:10px;color:var(--primary);font-weight:bold">Processing...</p></div>
    <div class="toast" id="toast">ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠</div>

    <div class="container">
        <div class="header">
            <h1>Rass 1 Pharmacy üíä</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="UI.show('list')">üìã Patients</button>
            <button class="tab" onclick="UI.show('add')">‚ûï Add New</button>
        </div>

        <div id="page-add" class="page">
            <div class="card">
                <div class="type-selector">
                    <button type="button" class="type-btn active" onclick="UI.setType('refill')" id="btn-refill">üíä Refill</button>
                    <button type="button" class="type-btn" onclick="UI.setType('order')" id="btn-order">üì¶ Order</button>
                </div>

                <form onsubmit="App.save(event)">
                    <input type="hidden" id="id">
                    <input type="hidden" id="type" value="refill">

                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="phone" placeholder="05xxxxxxxx" required>
                    </div>

                    <div class="form-group">
                        <label>Patient Name</label>
                        <input type="text" id="name" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label>Medication *</label>
                        <input type="text" id="med" required>
                    </div>

                    <div id="refill-fields">
                        <div class="form-group"><label>Dispense Date</label><input type="date" id="date"></div>
                        <div class="form-group"><label>Duration (Days)</label><input type="number" id="days" value="30"></div>
                    </div>

                    <div id="order-fields" style="display:none">
                        <div class="form-group"><label>Source Branch</label><input type="text" id="branch" placeholder="e.g. Unizah 1"></div>
                    </div>

                    <div class="form-group"><label>Notes</label><input type="text" id="notes"></div>

                    <button type="submit" class="btn btn-primary">üíæ Save Record</button>
                </form>
            </div>
        </div>

        <div id="page-list" class="page active">
            <div class="stats">
                <div class="stat"><div class="stat-num" id="st-total">0</div><div class="stat-lbl">Total</div></div>
                <div class="stat"><div class="stat-num" style="color:#f59e0b" id="st-due">0</div><div class="stat-lbl">Due Soon</div></div>
                <div class="stat"><div class="stat-num" style="color:#ef4444" id="st-over">0</div><div class="stat-lbl">Overdue</div></div>
            </div>

            <div class="card">
                <input type="text" id="search" placeholder="üîç Search..." onkeyup="App.render()" style="margin-bottom:10px">
                <div style="overflow-x:auto">
                    <table id="table">
                        <thead><tr><th>Patient</th><th>Medication</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
// ============================================
// üî¥ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÖÿØŸÖÿ¨ ŸáŸÜÿß
const API_URL = "https://script.google.com/macros/s/AKfycbykcl1v2TEURnPasMiMbJFCmnC6MgGfhHCAGmwOM6vu_sxpt7CdFM6NcDCRDxrGPVlo/exec";
// ============================================

const WA_ICON = `<svg viewBox="0 0 32 32" width="16" height="16" fill="white"><path d="M16,2A13,13,0,0,0,4.9,22.2L2,30l7.8-2.9A13,13,0,1,0,16,2z M22.7,21.7c-0.3,0.8-1.5,1.5-2.1,1.5c-0.6,0-2.3-0.7-5.4-3.6c-2.4-2.3-3.8-4.5-4.1-5.1s0-1,0.6-1.6c0.3-0.3,0.5-0.5,0.7-0.8c0.2-0.2,0.1-0.5,0-0.7s-1.2-3-1.6-4.1c-0.4-1.1-0.9-0.9-1.2-0.9H9.1c-0.4,0-1,0.2-1.6,0.8c-0.6,0.6-2.2,2.2-2.2,5.3s2.3,6.1,2.6,6.5c0.3,0.4,4.4,6.7,10.7,9.4c3.7,1.6,5.2,1.6,6.1,1.5c1-0.1,2.7-1.1,3.1-2.2C28.1,22.9,28.1,22.1,27.8,22C27.5,21.9,26,21.1,25.4,20.8C24.8,20.5,24.4,20.3,24.2,20.6C24,21,23.3,21.9,22.7,21.7z"/></svg>`;
let data = [];

// App Logic
const App = {
    init() {
        document.getElementById('date').valueAsDate = new Date();
        this.load();
    },

    async load() {
        UI.loading(true);
        // Load local first
        const local = localStorage.getItem('rass_data');
        if(local) { data = JSON.parse(local); this.render(); }
        
        try {
            // Fetch from Server (POST method to match your new script)
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get' })
            });
            const fresh = await res.json();
            if(Array.isArray(fresh)) {
                data = fresh;
                localStorage.setItem('rass_data', JSON.stringify(data));
                this.render();
            }
        } catch(e) { console.error(e); }
        UI.loading(false);
    },

    async save(e) {
        e.preventDefault();
        UI.loading(true);
        
        const item = {
            id: document.getElementById('id').value || Date.now().toString(),
            type: document.getElementById('type').value,
            phone: document.getElementById('phone').value,
            name: document.getElementById('name').value,
            med: document.getElementById('med').value,
            date: document.getElementById('date').value,
            days: document.getElementById('days').value,
            branch: document.getElementById('branch').value,
            notes: document.getElementById('notes').value
        };

        // Update Local
        const idx = data.findIndex(x => x.id == item.id);
        if(idx > -1) data[idx] = item; else data.push(item);
        this.render();
        UI.reset();
        UI.show('list');
        UI.toast('Saved Successfully');

        // Sync Server
        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: idx > -1 ? 'update' : 'add', data: item })
            });
        } catch(e) { console.error(e); }
        UI.loading(false);
    },

    async del(id) {
        if(!confirm('Delete?')) return;
        data = data.filter(x => x.id != id);
        this.render();
        localStorage.setItem('rass_data', JSON.stringify(data));
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', data: {id} }) });
    },

    render() {
        const q = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tbody');
        const today = new Date();
        let stats = { total:0, due:0, over:0 };

        const html = data.filter(x => (x.name+x.phone+x.med).toLowerCase().includes(q))
        .sort((a,b) => new Date(a.date||'2099') - new Date(b.date||'2099'))
        .map(x => {
            stats.total++;
            let badge = '', sub = '';
            
            if(x.type === 'refill') {
                const next = new Date(new Date(x.date).getTime() + (x.days||30)*86400000);
                const diff = Math.ceil((next - today)/86400000);
                sub = next.toLocaleDateString('en-US',{month:'short',day:'numeric'});
                
                if(diff < 0) { badge=`<span class="badge b-bad">Over ${Math.abs(diff)}d</span>`; stats.over++; }
                else if(diff <= 3) { badge=`<span class="badge b-warn">${diff}d Left</span>`; stats.due++; }
                else { badge=`<span class="badge b-ok">${diff}d Left</span>`; }
            } else {
                badge = `<span class="badge b-ord">Order</span>`;
                sub = x.branch || '-';
            }

            return `<tr>
                <td><div style="font-weight:bold">${x.name||'Guest'}</div><div style="font-size:12px;color:#888">${x.phone}</div></td>
                <td><div style="color:var(--primary);font-weight:500">${x.med}</div><div style="font-size:11px;color:#888">${x.notes||''}</div></td>
                <td><div style="font-size:12px">${sub}</div>${badge}</td>
                <td><div class="actions">
                    <button class="btn-wa" onclick="App.wa('${x.phone}','${x.med}')">${WA_ICON}</button>
                    <button class="btn-edit" onclick="App.edit('${x.id}')">‚úèÔ∏è</button>
                    <button class="btn-del" onclick="App.del('${x.id}')">üóëÔ∏è</button>
                </div></td>
            </tr>`;
        }).join('');
        
        tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999">No records</td></tr>';
        document.getElementById('st-total').innerText = stats.total;
        document.getElementById('st-due').innerText = stats.due;
        document.getElementById('st-over').innerText = stats.over;
    },

    edit(id) {
        const x = data.find(i => i.id == id);
        document.getElementById('id').value = x.id;
        document.getElementById('phone').value = x.phone;
        document.getElementById('name').value = x.name;
        document.getElementById('med').value = x.med;
        document.getElementById('notes').value = x.notes;
        UI.setType(x.type);
        if(x.type === 'refill') {
            document.getElementById('date').value = x.date;
            document.getElementById('days').value = x.days;
        } else {
            document.getElementById('branch').value = x.branch;
        }
        UI.show('add');
    },

    wa(phone, med) {
        let p = phone.replace(/\D/g,'');
        if(!p.startsWith('966')) p = '966'+p.replace(/^0/,'');
        window.open(`https://wa.me/${p}?text=${encodeURIComponent('ÿ™ÿ∞ŸÉŸäÿ± ÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä: ÿπŸÑÿßÿ¨ŸÉ ÿ¨ÿßŸáÿ≤ ('+med+')')}`);
    }
};

const UI = {
    show(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active'); // This line might bug if called from code, but works for clicks
    },
    setType(t) {
        document.getElementById('type').value = t;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+t).classList.add('active');
        document.getElementById('refill-fields').style.display = t === 'refill' ? 'block' : 'none';
        document.getElementById('order-fields').style.display = t === 'order' ? 'block' : 'none';
    },
    loading(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; },
    toast(m) { 
        const t = document.getElementById('toast'); 
        t.innerText = m; t.style.display='block'; 
        setTimeout(()=>t.style.display='none',3000); 
    },
    reset() {
        document.forms[0].reset();
        document.getElementById('id').value = '';
        document.getElementById('date').valueAsDate = new Date();
        this.setType('refill');
    }
};

// Start
document.addEventListener('DOMContentLoaded', ()=>App.init());
</script>
</body>
</html>
