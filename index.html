<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 1 Hub</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        :root{--primary:#561C2C;--primary-light:#7a2840;--accent:#8DC63F;--accent-dark:#6fa329;--text-dark:#333;--gray:#666;--gray-light:#f5f5f5;--white:#fff;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--order-bg:#eff6ff;--shadow-sm:0 2px 4px rgba(0,0,0,0.05);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 25px rgba(0,0,0,0.1);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-full:9999px;--transition:0.3s ease}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(180deg,#f9f6f2 0%,#e8dccf 100%);color:var(--text-dark);min-height:100vh;padding:15px;line-height:1.6}
        .toast-container{position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px}
        .toast{padding:14px 20px;border-radius:var(--radius-md);color:white;font-weight:500;box-shadow:var(--shadow-lg);animation:slideIn .3s ease;display:flex;align-items:center;gap:10px;min-width:280px}
        .toast.hiding{animation:slideOut .3s ease forwards}
        .toast-success{background:var(--success)}.toast-error{background:var(--danger)}.toast-warning{background:var(--warning)}.toast-info{background:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;z-index:9999;opacity:0;visibility:hidden;transition:var(--transition)}
        .loading-overlay.active{opacity:1;visibility:visible}
        .spinner{width:50px;height:50px;border:4px solid var(--gray-light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{color:var(--primary);font-weight:600}
        @keyframes spin{to{transform:rotate(360deg)}}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9998;opacity:0;visibility:hidden;transition:var(--transition)}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:white;border-radius:var(--radius-lg);padding:25px;max-width:400px;width:90%;text-align:center;transform:scale(0.9);transition:var(--transition)}
        .modal-overlay.active .modal{transform:scale(1)}
        .modal-icon{font-size:48px;margin-bottom:15px}.modal-title{font-size:18px;font-weight:bold;color:var(--text-dark);margin-bottom:10px}.modal-message{color:var(--gray);margin-bottom:20px;line-height:1.6}
        .modal-actions{display:flex;gap:10px;justify-content:center}
        .modal-actions button{padding:10px 24px;border-radius:var(--radius-sm);font-weight:bold;cursor:pointer;transition:var(--transition);border:none;flex:1}
        .modal-cancel{background:#e5e5e5;color:var(--text-dark)}.modal-cancel:hover{background:#d5d5d5}
        .modal-confirm{background:var(--primary);color:white}.modal-confirm:hover{background:var(--primary-light)}
        .modal-confirm.danger{background:var(--danger)}.modal-confirm.danger:hover{background:#dc2626}
        .modal-confirm.success{background:var(--success)}.modal-confirm.success:hover{background:#059669}
        .container{max-width:1200px;margin:0 auto}
        .header-container{text-align:center;margin-bottom:20px}
        .logo-img{height:80px;margin-bottom:10px;filter:drop-shadow(0 2px 4px rgba(86,28,44,0.2))}
        h1{color:var(--primary);margin-bottom:8px;font-weight:700;font-size:22px}
        .tabs{display:flex;justify-content:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
        .tab{background:rgba(255,255,255,0.7);border:none;padding:10px 20px;border-radius:var(--radius-full);cursor:pointer;font-weight:bold;color:var(--gray);transition:var(--transition);box-shadow:var(--shadow-sm);position:relative;font-size:13px}
        .tab.active{background:var(--primary);color:white;box-shadow:0 4px 10px rgba(86,28,44,0.3)}
        .tab:hover:not(.active){background:white;transform:translateY(-2px)}
        .tab-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;font-size:10px;font-weight:bold;padding:2px 6px;border-radius:var(--radius-full);min-width:18px}
        .page{display:none;animation:fadeIn .3s ease}.page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
        .grid{display:grid;grid-template-columns:350px 1fr;gap:20px}
        @media(max-width:900px){.grid{grid-template-columns:1fr}}
        .card{background:var(--white);border-radius:var(--radius-lg);padding:20px;margin-bottom:15px;box-shadow:var(--shadow-lg)}
        .card-title{color:var(--primary);margin-bottom:15px;font-size:16px;font-weight:600}
        
        .type-selector{display:flex;gap:8px;margin-bottom:15px}
        .type-btn{flex:1;padding:12px;border:2px solid #e5e5e5;border-radius:var(--radius-md);background:white;cursor:pointer;transition:var(--transition);text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .type-btn:hover{border-color:var(--primary)}
        .type-btn.active{border-color:var(--primary);background:rgba(86,28,44,0.05)}
        .type-btn.active.order{border-color:var(--info);background:var(--order-bg)}
        .type-btn-icon{font-size:20px;margin-bottom:2px}
        .type-btn-label{font-weight:600;color:var(--text-dark);font-size:12px}
        .type-badge{font-size:14px;margin-right:5px}
        tr.order-row{background:var(--order-bg)}
        tr.order-row:hover{background:#e0edff}
        .badge-delivered{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .badge-waiting{background:rgba(245,158,11,0.15);color:#d97706}
        .branch-info{color:var(--info);font-size:11px;font-weight:600}
        .report-tabs{display:flex;gap:5px;margin-bottom:15px;border-bottom:1px solid #eee}
        .report-tab{padding:8px 16px;border:none;background:none;cursor:pointer;font-weight:600;color:var(--gray);border-bottom:3px solid transparent}
        .report-tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .report-section{display:none}.report-section.active{display:block}
        
        .form-group{margin-bottom:12px}
        label{display:block;margin-bottom:4px;color:#555;font-size:13px;font-weight:600}
        label .required{color:var(--danger)}
        input,select{width:100%;padding:12px;background:#fafafa;border:2px solid #e5e5e5;border-radius:var(--radius-sm);color:#333;font-size:16px;transition:var(--transition)}
        input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(86,28,44,0.1);background:white}
        input.error{border-color:var(--danger);background:#fef2f2}
        .error-message{color:var(--danger);font-size:11px;margin-top:3px;display:none}.error-message.show{display:block}
        .row{display:flex;flex-direction:column;gap:10px}
        .btn{padding:12px 20px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:bold;width:100%;margin-top:8px;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:var(--primary);color:white}.btn-primary:hover:not(:disabled){background:var(--primary-light);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .btn-secondary{background:#6c757d;color:white}.btn-secondary:hover:not(:disabled){background:#5a6268}
        .btn-success{background:var(--success);color:white}.btn-success:hover:not(:disabled){background:#059669}
        .btn-info{background:var(--info);color:white}.btn-info:hover:not(:disabled){background:#2563eb}
        .btn-danger{background:var(--danger);color:white}.btn-danger:hover:not(:disabled){background:#dc2626}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important}
        .btn-sm{padding:8px 16px;width:auto;margin:0;font-size:12px}
        .filters-row{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .filters-row input{flex:1;min-width:200px}.filters-row select{width:auto;min-width:130px}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
        th{text-align:left;padding:12px 10px;background:#f9f9f9;color:var(--gray);font-size:11px;text-transform:uppercase;border-bottom:2px solid #eee;white-space:nowrap}
        td{padding:12px 10px;border-bottom:1px solid #eee;vertical-align:middle}
        tr:hover{background:#fcfcfc}
        .name{font-weight:bold;color:var(--primary)}
        .phone{color:#888;font-size:12px;margin-top:2px;display:flex;align-items:center;gap:5px}
        .phone-copy{cursor:pointer;padding:2px 5px;border-radius:4px;transition:var(--transition)}.phone-copy:hover{background:#e5e5e5}
        .med{color:var(--primary);font-weight:500}
        .date-added{color:#888;font-size:12px}
        .badge{padding:5px 12px;border-radius:var(--radius-full);font-size:10px;font-weight:bold;letter-spacing:0.5px;white-space:nowrap}
        .badge-ok{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .badge-warn{background:rgba(245,158,11,0.15);color:#d97706}
        .badge-danger{background:rgba(239,68,68,0.15);color:#dc2626}
        .badge-info{background:rgba(59,130,246,0.15);color:var(--info)}
        .badge-client{background:rgba(239,68,68,0.15);color:#dc2626;font-size:9px;padding:3px 8px}
        .actions{display:flex;gap:5px;flex-wrap:wrap}
        .actions button{width:32px;height:32px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:var(--transition);display:flex;align-items:center;justify-content:center}
        .wa{background:#25D366;color:white}.wa svg{width:18px;height:18px;fill:white}
        .edit{background:rgba(86,28,44,0.1);color:var(--primary)}.del{background:rgba(239,68,68,0.1);color:#ef4444}
        .email-btn{background:rgba(59,130,246,0.15);color:var(--info)}
        .arrived{background:rgba(59,130,246,0.15);color:var(--info)}.done{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .actions button:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm)}
        .empty{text-align:center;padding:40px;color:#aaa;font-style:italic}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px}
        .stat{background:white;padding:15px;border-radius:var(--radius-md);box-shadow:var(--shadow-md);position:relative;overflow:hidden}
        .stat::after{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--gray)}
        .stat-num{font-size:24px;font-weight:800;color:var(--text-dark)}.stat-label{color:#888;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;margin-top:3px}
        .stat.total::after{background:var(--primary)}.stat.w::after{background:#f59e0b}.stat.d::after{background:#ef4444}.stat.s::after{background:var(--accent)}.stat.orders::after{background:var(--info)}
        .sync{text-align:center;padding:8px 14px;font-size:12px;margin-bottom:15px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;gap:6px}
        .sync-ok{color:var(--accent-dark);border:1px solid rgba(141,198,63,0.3)}.sync-err{color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
        .alert-banner{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border:1px solid #f59e0b;border-radius:var(--radius-md);padding:12px 15px;margin-bottom:15px;display:flex;align-items:center;gap:10px;animation:fadeIn .3s ease}
        .alert-banner.hidden{display:none}.alert-banner-icon{font-size:20px}.alert-banner-text{flex:1;font-weight:500;color:#92400e;font-size:13px}.alert-banner-close{background:none;border:none;font-size:18px;cursor:pointer;color:#92400e;padding:5px}
        .pagination{display:flex;justify-content:center;align-items:center;gap:6px;margin-top:15px;flex-wrap:wrap}
        .pagination button{padding:6px 12px;border:1px solid #ddd;background:white;border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition);font-weight:500;font-size:12px}
        .pagination button:hover:not(:disabled):not(.active){border-color:var(--primary);color:var(--primary)}
        .pagination button.active{background:var(--primary);color:white;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        .pagination-info{color:var(--gray);font-size:11px;margin-left:8px}
        .track-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
        .track-card{background:white;border:2px solid #eee;border-radius:var(--radius-md);padding:15px;transition:var(--transition);box-shadow:var(--shadow-sm)}
        .track-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .track-card.converted{border-color:var(--accent);background:rgba(141,198,63,0.05)}
        .track-card .name{font-size:15px;margin-bottom:4px;color:#333}.track-card .med{margin:8px 0;color:var(--primary);font-size:13px}.track-card .info{font-size:11px;color:#888;margin-bottom:12px;line-height:1.4}
        .track-card .history-badge{font-size:10px;color:var(--accent-dark);background:rgba(141,198,63,0.1);padding:3px 8px;border-radius:10px;margin-bottom:8px;display:inline-block}
        .track-btn{width:100%;padding:10px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:bold;font-size:13px;background:rgba(141,198,63,0.15);color:var(--accent-dark);transition:var(--transition);margin-bottom:6px}
        .track-btn:hover{background:var(--accent);color:white}.track-btn.done{background:var(--accent);color:white}
        .track-btn.renew{background:rgba(86,28,44,0.1);color:var(--primary)}.track-btn.renew:hover{background:var(--primary);color:white}
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
        .report-card{background:var(--white);border-radius:var(--radius-md);padding:20px;text-align:center;box-shadow:var(--shadow-lg)}
        .report-value{font-size:36px;font-weight:bold;color:var(--primary)}.report-label{font-size:12px;color:#888;margin-top:4px}
        .progress{height:8px;background:#eee;border-radius:6px;margin-top:12px;overflow:hidden}
        .progress-bar{height:100%;border-radius:6px;transition:width .5s ease}
        .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
        
        /* Order items list */
        .order-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f9f9f9;border-radius:var(--radius-sm);margin-bottom:8px;gap:10px}
        .order-item-info{flex:1}
        .order-item-med{font-weight:600;color:var(--primary);font-size:13px}
        .order-item-details{font-size:11px;color:var(--gray);margin-top:2px}
        .order-item-branch{font-size:11px;color:var(--info);font-weight:500}
        .order-item-del{background:none;border:none;color:var(--danger);cursor:pointer;font-size:16px;padding:5px}
        /* Ready to send section */
        .send-section{margin-top:20px;padding-top:15px;border-top:2px dashed #e5e5e5}
        .send-group{background:#f0f7ff;border:1px solid #bfdbfe;border-radius:var(--radius-md);padding:15px;margin-bottom:12px}
        .send-group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .send-group-title{font-weight:bold;color:var(--info);font-size:14px}
        .send-group-count{font-size:11px;color:var(--gray);background:white;padding:2px 8px;border-radius:10px}
        .send-group-items{font-size:12px;color:var(--text-dark);line-height:1.6}
        .send-group-item{padding:3px 0}
        .send-group-item.client{color:var(--danger)}
        @media(max-width:600px){
            body{padding:10px}
            .header-container h1{font-size:18px}
            .logo-img{height:60px}
            .tabs{gap:5px}
            .tab{padding:8px 12px;font-size:11px}
            .card{padding:15px}
            .stats{grid-template-columns:1fr 1fr;gap:8px}
            .stat{padding:12px}
            .stat-num{font-size:20px}
            .stat-label{font-size:9px}
            table{font-size:11px}
            th,td{padding:8px 6px}
            .actions{gap:3px}
            .actions button{width:28px;height:28px;font-size:12px}
            .badge{padding:3px 8px;font-size:9px}
            .report-grid{grid-template-columns:1fr 1fr}
            .report-value{font-size:28px}
            .track-grid{grid-template-columns:1fr}
            .btn{padding:10px 15px}
            .header-row{flex-direction:column;align-items:stretch}
            input,select{padding:10px;font-size:16px}
            .row{flex-direction:column}
            .filters-row{flex-direction:column}
            .filters-row select{width:100%}
            .toast{min-width:auto;width:calc(100vw - 40px)}
            .grid{grid-template-columns:1fr}
        }
        @media(min-width:768px){
            .row{flex-direction:row;gap:10px}
            .row .form-group{flex:1}
        }
        @media print{body{background:white}.tabs,.sync,.header-row button,.actions,.pagination,.filters-row select,.alert-banner,.type-selector{display:none!important}.card{box-shadow:none;border:1px solid #ddd}}
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text">Loading...</div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal"><div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div><div class="modal-title" id="modalTitle">Confirm</div><div class="modal-message" id="modalMessage">Are you sure?</div><div class="modal-actions"><button class="modal-cancel" onclick="UI.closeModal()">Cancel</button><button class="modal-confirm" id="modalConfirm">Confirm</button></div></div></div>

<div class="container">
    <div class="header-container">
        <img src="logo.png" alt="Rass 1" class="logo-img" onerror="this.style.display='none'">
        <h1>Rass 1 Hub</h1>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-page="patients">üíä Records</button>
        <button class="tab" data-page="orders">üì¶ Transfer Requests</button>
        <button class="tab" data-page="tracking">üìä Tracking</button>
        <button class="tab" data-page="reports">üìà Reports</button>
    </div>
    
    <div id="sync" class="sync sync-ok">‚úì Connected to Google Sheets</div>
    <div class="alert-banner hidden" id="alertBanner"><span class="alert-banner-icon">üîî</span><span class="alert-banner-text" id="alertText"></span><button class="alert-banner-close" onclick="document.getElementById('alertBanner').classList.add('hidden')">√ó</button></div>
    
    <div id="patientsPage" class="page active">
        <div class="stats">
            <div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Records</div></div>
            <div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Soon</div></div>
            <div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Overdue</div></div>
            <div class="stat orders"><div class="stat-num" id="pendingOrders">0</div><div class="stat-label">üì¶ Pending</div></div>
        </div>
        <div class="grid">
            <div class="card">
                <h3 class="card-title" id="formTitle">‚ûï Add New</h3>
                
                <div class="type-selector">
                    <button type="button" class="type-btn active refill" data-type="refill" onclick="setEntryType('refill')">
                        <div class="type-btn-icon">üíä</div>
                        <div class="type-btn-label">Refill</div>
                    </button>
                    <button type="button" class="type-btn order" data-type="order" onclick="setEntryType('order')">
                        <div class="type-btn-icon">üì¶</div>
                        <div class="type-btn-label">Order</div>
                    </button>
                </div>

                <form id="patientForm" novalidate>
                    <input type="hidden" id="entryType" value="refill">
                    <div class="form-group"><label>Customer Name (Optional)</label><input type="text" id="name" placeholder="Enter name"></div>
                    <div class="form-group"><label>Phone <span class="required">*</span></label><input type="tel" id="phone" placeholder="966512345678"><div class="error-message" id="phoneError">Please enter a valid phone</div></div>
                    
                    <div class="form-group">
                        <label id="medLabel">Medication <span class="required">*</span></label>
                        <input type="text" id="med" placeholder="Medication name">
                        <div class="error-message" id="medError">Please enter medication</div>
                    </div>
                    
                    <div id="refillFields">
                        <div class="row">
                            <div class="form-group"><label>Dispense Date <span class="required">*</span></label><input type="date" id="date"><div class="error-message" id="dateError">Please select date</div></div>
                            <div class="form-group"><label>Duration (days) <span class="required">*</span></label><input type="number" id="days" value="30" min="1" max="365"><div class="error-message" id="daysError">Enter 1-365</div></div>
                        </div>
                    </div>

                    <div id="orderFields" style="display:none">
                        <div class="form-group">
                            <label>From Branch <span class="required">*</span></label>
                            <select id="branch">
                                <option value="">Select branch...</option>
                                <option>RASS2</option><option>RASS5</option><option>UNIZAH1</option><option>UNIZAH2</option><option>UNIZAH3</option><option>UNIZAH5</option>
                                <option>BADAYA1</option><option>BADAYA2</option><option>BADAYA3</option><option>BADAYA5</option><option>BADAYA.MOR</option>
                                <option>BUKAYRIAH1</option><option>BUKAYRIAH2</option><option>BUKAYRIAH.MOR</option>
                                <option>BURIDAH1</option><option>BURIDAH2</option>
                                <option>KHABRA1</option><option>MITHNAB1</option><option>MITHNAB2</option><option>RIYADH.KHABRA.MOR</option>
                            </select>
                            <div class="error-message" id="branchError">Please select branch</div>
                        </div>
                        <div class="form-group">
                            <label>Pickup Date (Optional)</label>
                            <select id="pickupDate">
                                <option value="">Not specified</option>
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDateGroup" style="display:none">
                            <label>Custom Date</label>
                            <input type="date" id="customPickupDate">
                        </div>
                    </div>

                    <div class="form-group"><label>Notes</label><input type="text" id="notes" placeholder="Additional notes"></div>
                    <button type="submit" class="btn btn-primary" id="submitBtn"><span>‚ûï</span> Add</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                </form>
            </div>
            <div class="card">
                <h3 class="card-title">üìã Records</h3>
                <div class="filters-row">
                    <input type="text" id="search" placeholder="üîç Search...">
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="refill">üíä Refill</option>
                        <option value="order">üì¶ Orders</option>
                    </select>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="overdue">üî¥ Overdue</option>
                        <option value="soon">üü° Soon</option>
                        <option value="ok">üü¢ OK</option>
                        <option value="waiting">üîµ Waiting</option>
                        <option value="pending">‚è≥ Pending</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Type</th><th>Customer</th><th>Item / Med</th><th>Added</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="patientsTbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>
    
    <div id="ordersPage" class="page">
        <div class="grid">
            <div class="card">
                <h3 class="card-title">‚ûï Add Item</h3>
                <form id="orderForm" novalidate>
                    <div class="form-group">
                        <label>Item Name <span class="required">*</span></label>
                        <input type="text" id="orderMed" placeholder="Product name">
                        <div class="error-message" id="orderMedError">Please enter item name</div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Quantity <span class="required">*</span></label>
                            <input type="number" id="orderQty" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>From Branch <span class="required">*</span></label>
                            <select id="orderBranch">
                                <option value="">Select...</option>
                                <option value="RASS2">RASS2</option>
                                <option value="RASS5">RASS5</option>
                                <option value="UNIZAH1">UNIZAH1</option>
                                <option value="UNIZAH2">UNIZAH2</option>
                                <option value="UNIZAH3">UNIZAH3</option>
                                <option value="UNIZAH5">UNIZAH5</option>
                                <option value="BADAYA1">BADAYA1</option>
                                <option value="BADAYA2">BADAYA2</option>
                                <option value="BADAYA3">BADAYA3</option>
                                <option value="BADAYA5">BADAYA5</option>
                                <option value="BADAYA.MOR">BADAYA.MOR</option>
                                <option value="BUKAYRIAH1">BUKAYRIAH1</option>
                                <option value="BUKAYRIAH2">BUKAYRIAH2</option>
                                <option value="BUKAYRIAH.MOR">BUKAYRIAH.MOR</option>
                                <option value="BURIDAH1">BURIDAH1</option>
                                <option value="BURIDAH2">BURIDAH2</option>
                                <option value="KHABRA1">KHABRA1</option>
                                <option value="MITHNAB1">MITHNAB1</option>
                                <option value="MITHNAB2">MITHNAB2</option>
                                <option value="RIYADH.KHABRA.MOR">RIYADH.KHABRA.MOR</option>
                            </select>
                            <div class="error-message" id="orderBranchError">Please select branch</div>
                        </div>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="orderClient">
                        <label for="orderClient">üî¥ ŸÑÿπŸÖŸäŸÑ (For Client)</label>
                    </div>
                    <button type="submit" class="btn btn-primary">‚ûï Add to List</button>
                </form>
            </div>
            
            <div class="card">
                <h3 class="card-title">üìã Transfer List</h3>
                <div id="ordersList"></div>
                <button class="btn btn-danger btn-sm" onclick="OrdersModule.clearAll()" style="margin-top:10px" id="clearAllBtn">üóëÔ∏è Clear All</button>
                
                <div class="send-section" id="sendSection" style="display:none">
                    <h3 class="card-title">üìß Ready to Send</h3>
                    <div id="groupedOrders"></div>
                    <button class="btn btn-success" onclick="OrdersModule.sendAllEmails()" style="margin-top:10px">üìß Send All Emails</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="trackingPage" class="page">
        <div class="stats">
            <div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">Sent</div></div>
            <div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">Converted</div></div>
            <div class="stat" style="border-left:4px solid var(--primary)"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Rate</div></div>
        </div>
        <div class="card">
            <div class="header-row">
                <h3 class="card-title" style="margin:0">üìä Track Conversions</h3>
                <select id="trackFilter" style="width:auto;min-width:140px">
                    <option value="all">All</option>
                    <option value="waiting">‚è≥ Waiting</option>
                    <option value="converted">‚úÖ Converted</option>
                </select>
            </div>
            <div class="track-grid" id="trackGrid"></div>
        </div>
    </div>
    
    <div id="reportsPage" class="page">
        <div class="card">
            <div class="header-row">
                <h3 class="card-title" style="margin:0">üìà Monthly Report</h3>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <select id="reportMonth" style="width:auto"></select>
                    <select id="reportYear" style="width:auto"></select>
                    <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è</button>
                </div>
            </div>
            <div class="report-tabs">
                <button class="report-tab active" data-report="refill" onclick="showReportTab('refill')">üíä Refill</button>
                <button class="report-tab" data-report="orders" onclick="showReportTab('orders')">üì¶ Transfers</button>
            </div>
        </div>

        <div id="refillReport" class="report-section active">
            <div class="report-grid">
                <div class="report-card"><div class="report-value" id="rSent">0</div><div class="report-label">üì§ Sent</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--accent)" id="rConverted">0</div><div class="report-label">‚úÖ Converted</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--primary)" id="rRate">0%</div><div class="report-label">üìä Rate</div><div class="progress"><div class="progress-bar" id="rBar" style="width:0%;background:var(--accent)"></div></div></div>
            </div>
            <div class="card">
                <h3 class="card-title">üìã Summary</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Metric</th><th>Count</th><th>%</th></tr></thead>
                        <tbody id="summaryTb"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">‚úÖ Converted Patients</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Patient</th><th>Phone</th><th>Medication</th><th>Reminder</th><th>Converted</th></tr></thead>
                        <tbody id="convList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ordersReport" class="report-section">
            <div class="report-grid">
                <div class="report-card"><div class="report-value" style="color:var(--info)" id="oTotal">0</div><div class="report-label">üì¶ Total</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--accent)" id="oDelivered">0</div><div class="report-label">‚úÖ Delivered</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--warning)" id="oNotDelivered">0</div><div class="report-label">‚è≥ Pending</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--primary)" id="oRate">0%</div><div class="report-label">üìä Rate</div><div class="progress"><div class="progress-bar" id="oBar" style="width:0%;background:var(--info)"></div></div></div>
            </div>
            <div class="card">
                <h3 class="card-title">üè¢ By Branch</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Branch</th><th>Total</th><th>Delivered</th><th>Pending</th></tr></thead>
                        <tbody id="branchSummary"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">üì¶ Top Items</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Item Name</th><th>Count</th></tr></thead>
                        <tbody id="topMeds"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>


<script>
// WhatsApp SVG Icon
const WA_ICON = '<svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>';

// Branch Emails
const BRANCH_EMAILS = {
    'RASS2': 'rass2@alraziksa.com',
    'RASS5': 'rass5@alraziksa.com',
    'UNIZAH1': 'unizah1@alraziksa.com',
    'UNIZAH2': 'unizah2@alraziksa.com',
    'UNIZAH3': 'unizah3@alraziksa.com',
    'UNIZAH5': 'unizah5@alraziksa.com',
    'BADAYA1': 'badaya1@alraziksa.com',
    'BADAYA2': 'badaya2@alraziksa.com',
    'BADAYA3': 'badaya3@alraziksa.com',
    'BADAYA5': 'badaya5@alraziksa.com',
    'BADAYA.MOR': 'badaya.mor@alraziksa.com',
    'BUKAYRIAH1': 'bukayriah1@alraziksa.com',
    'BUKAYRIAH2': 'bukayriah2@alraziksa.com',
    'BUKAYRIAH.MOR': 'bukayriah.mor@alraziksa.com',
    'BURIDAH1': 'buridah1@alraziksa.com',
    'BURIDAH2': 'buridah2@alraziksa.com',
    'KHABRA1': 'khabra1@alraziksa.com',
    'MITHNAB1': 'mithnab1@alraziksa.com',
    'MITHNAB2': 'mithnab2@alraziksa.com',
    'RIYADH.KHABRA.MOR': 'riyadh.khabra.mor@alraziksa.com'
};

const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbzScqUsOESP_1EQZBqYvXLbkoOkNsDm2_o5twRHbU078-1e5HI7uSgmhDy_mkAmfLv-ig/exec',
    ITEMS_PER_PAGE: 10,
    SEARCH_DELAY: 300,
    TOAST_DURATION: 3000,
    PHONE_REGEX: /^(966|0)?5\d{8}$/,
    MONTHS: ['January','February','March','April','May','June','July','August','September','October','November','December']
};

const State = {
    patients: [],
    editId: null,
    currentPage: 1,
    searchQuery: '',
    statusFilter: 'all',
    typeFilter: 'all',
    entryType: 'refill',
    searchTimeout: null,
    // Orders state (for quick list)
    orderItems: []
};

const Utils = {
    formatDate(v){if(!v)return'';if(typeof v==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(v))return v;const d=new Date(v);if(isNaN(d))return v;return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')},
    formatDisplayDate(s){if(!s)return'-';const d=new Date(s);if(isNaN(d))return s;return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})},
    getToday(){const t=new Date();return t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0')},
    getTomorrow(){const t=new Date();t.setDate(t.getDate()+1);return t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0')},
    parseHistory(h){if(!h)return[];if(Array.isArray(h))return h;try{return JSON.parse(h)}catch(e){return[]}},
    getRefillDate(p){const d=new Date(p.date);d.setDate(d.getDate()+parseInt(p.days||30));return d},
    getDaysUntilRefill(p){const t=new Date();t.setHours(0,0,0,0);const r=this.getRefillDate(p);r.setHours(0,0,0,0);return Math.ceil((r-t)/(1000*60*60*24))},
    sanitize(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML},
    validatePhone(p){return CONFIG.PHONE_REGEX.test(p.replace(/\D/g,''))},
    formatPhone(p){let c=p.replace(/\D/g,'');if(c.startsWith('0'))c='966'+c.substring(1);else if(!c.startsWith('966'))c='966'+c;return c},
    debounce(f,d){return function(...a){clearTimeout(State.searchTimeout);State.searchTimeout=setTimeout(()=>f.apply(this,a),d)}},
    copyToClipboard(t){navigator.clipboard.writeText(t).then(()=>UI.showToast('Copied!','success')).catch(()=>UI.showToast('Failed','error'))}
};

const UI = {
    showToast(m,t='info'){const c=document.getElementById('toastContainer');const e=document.createElement('div');e.className='toast toast-'+t;const i={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};e.innerHTML='<span>'+i[t]+'</span><span>'+m+'</span>';c.appendChild(e);setTimeout(()=>{e.classList.add('hiding');setTimeout(()=>e.remove(),300)},CONFIG.TOAST_DURATION)},
    setLoading(s,t='Loading...'){const o=document.getElementById('loadingOverlay');o.querySelector('.loading-text').textContent=t;o.classList.toggle('active',s)},
    setSyncStatus(c){const e=document.getElementById('sync');e.className=c?'sync sync-ok':'sync sync-err';e.textContent=c?'‚úì Connected to Google Sheets':'‚ö† Offline Mode'},
    showModal(o){const{icon='‚ö†Ô∏è',title,message,confirmText='Confirm',confirmClass='',onConfirm}=o;document.getElementById('modalIcon').textContent=icon;document.getElementById('modalTitle').textContent=title;document.getElementById('modalMessage').textContent=message;const b=document.getElementById('modalConfirm');b.textContent=confirmText;b.className='modal-confirm '+confirmClass;b.onclick=()=>{onConfirm();this.closeModal()};document.getElementById('confirmModal').classList.add('active')},
    closeModal(){document.getElementById('confirmModal').classList.remove('active')},
    showFieldError(f,s){const e=document.getElementById(f);const m=document.getElementById(f+'Error');if(e)e.classList.toggle('error',s);if(m)m.classList.toggle('show',s)},
    clearFieldErrors(){['phone','med','date','days','orderMed','orderBranch','branch'].forEach(f=>this.showFieldError(f,false))},
    showAlert(m){document.getElementById('alertText').textContent=m;document.getElementById('alertBanner').classList.remove('hidden')},
    updateOrdersBadge(){
        const p=State.patients.filter(x=>x.type==='order'&&x.orderStatus!=='delivered').length;
        const t=document.querySelector('[data-page="patients"]');
        let b=t.querySelector('.tab-badge');
        if(p>0){
            if(!b){b=document.createElement('span');b.className='tab-badge';t.appendChild(b)}
            b.textContent=p;
        }else if(b)b.remove();
    }
};

const API = {
    async request(a,d=null){try{let u=CONFIG.API_URL+'?action='+a;if(d)u+='&data='+encodeURIComponent(JSON.stringify(d));const r=await fetch(u);UI.setSyncStatus(true);return await r.json()}catch(e){console.error('API Error:',e);UI.setSyncStatus(false);throw e}},
    async loadPatients(){
        UI.setLoading(true,'Loading...');
        try{
            const d=await this.request('get');
            State.patients=d.map(p=>({
                id:String(p.id||''),
                type:p.type||'refill',
                name:p.name||'',
                phone:String(p.phone||''),
                med:p.med||'',
                date:Utils.formatDate(p.date),
                days:String(p.days||'30'),
                notes:p.notes||'',
                addedDate:Utils.formatDate(p.addedDate)||Utils.formatDate(p.date),
                branch:p.branch||'',
                pickupDate:p.pickupDate||'',
                orderStatus:p.orderStatus||'waiting',
                arrivedDate:Utils.formatDate(p.arrivedDate),
                deliveredDate:Utils.formatDate(p.deliveredDate),
                reminderSent:p.reminderSent||'no',
                reminderDate:Utils.formatDate(p.reminderDate),
                converted:p.converted||'no',
                convertedDate:Utils.formatDate(p.convertedDate),
                history:Utils.parseHistory(p.history)
            }));
            localStorage.setItem('patients_rass1',JSON.stringify(State.patients));
            checkTodayAlerts();
        }catch(e){
            State.patients=JSON.parse(localStorage.getItem('patients_rass1'))||[];
            UI.showToast('Loaded from cache','warning');
        }finally{
            UI.setLoading(false);
            renderPatients();
            UI.updateOrdersBadge();
        }
    },
    async savePatient(p,a){
        const d={...p,history:JSON.stringify(p.history||[])};
        try{
            if(a==='delete')await fetch(CONFIG.API_URL+'?action=delete&id='+p.id);
            else await this.request(a,d);
            UI.setSyncStatus(true);
        }catch(e){UI.setSyncStatus(false)}
        localStorage.setItem('patients_rass1',JSON.stringify(State.patients));
    }
};

// ==================== UI HELPERS ====================
function setEntryType(t){
    State.entryType=t;
    document.getElementById('entryType').value=t;
    document.querySelectorAll('.type-btn').forEach(b=>{
        b.classList.remove('active');
        if(b.dataset.type===t)b.classList.add('active');
    });
    
    // Dynamic Label Switching
    const medLabel = document.getElementById('medLabel');
    const medInput = document.getElementById('med');
    
    if(t === 'refill') {
        medLabel.innerHTML = 'Medication <span class="required">*</span>';
        medInput.placeholder = 'Medication name';
    } else {
        medLabel.innerHTML = 'Item Name <span class="required">*</span>';
        medInput.placeholder = 'Product or Item name';
    }
    
    document.getElementById('refillFields').style.display=t==='refill'?'block':'none';
    document.getElementById('orderFields').style.display=t==='order'?'block':'none';
    document.getElementById('submitBtn').innerHTML='<span>‚ûï</span> Add '+(t==='refill'?'Patient':'Order');
    UI.clearFieldErrors();
}

function handlePickupDateChange(){
    document.getElementById('customDateGroup').style.display=document.getElementById('pickupDate').value==='custom'?'block':'none';
}

function showReportTab(t){
    document.querySelectorAll('.report-tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.report-section').forEach(x=>x.classList.remove('active'));
    document.querySelector('[data-report="'+t+'"]').classList.add('active');
    document.getElementById(t==='refill'?'refillReport':'ordersReport').classList.add('active');
}

// ==================== PATIENT ACTIONS ====================
const PatientActions = {
    async save(e){
        e.preventDefault();
        UI.clearFieldErrors();
        
        const t = State.entryType;
        const phone = document.getElementById('phone').value;
        const med = document.getElementById('med').value.trim();
        let valid = true;
        
        if(!Utils.validatePhone(phone)){UI.showFieldError('phone',true);valid=false}
        if(!med){UI.showFieldError('med',true);valid=false}
        
        if(t==='refill'){
            if(!document.getElementById('date').value){UI.showFieldError('date',true);valid=false}
            const d=parseInt(document.getElementById('days').value);
            if(!d||d<1||d>365){UI.showFieldError('days',true);valid=false}
        } else {
            if(!document.getElementById('branch').value){UI.showFieldError('branch',true);valid=false}
        }
        
        if(!valid){UI.showToast('Please fix errors','error');return}
        
        const btn=document.getElementById('submitBtn');
        btn.disabled=true;
        btn.innerHTML='<span>‚è≥</span> Saving...';
        
        let pk='';
        if(t==='order'){
            const pv=document.getElementById('pickupDate').value;
            if(pv==='today')pk=Utils.getToday();
            else if(pv==='tomorrow')pk=Utils.getTomorrow();
            else if(pv==='custom')pk=document.getElementById('customPickupDate').value;
        }
        
        const p={
            id:State.editId||Date.now().toString(),
            type:t,
            name:document.getElementById('name').value.trim(),
            phone:Utils.formatPhone(phone),
            med:med,
            date:t==='refill'?document.getElementById('date').value:'',
            days:t==='refill'?document.getElementById('days').value:'',
            notes:document.getElementById('notes').value.trim(),
            addedDate:State.editId?null:Utils.getToday(),
            branch:t==='order'?document.getElementById('branch').value:'',
            pickupDate:pk,
            orderStatus:t==='order'?'waiting':'',
            arrivedDate:'',
            deliveredDate:'',
            reminderSent:'no',
            reminderDate:'',
            converted:'no',
            convertedDate:'',
            history:[]
        };
        
        if(State.editId){
            const x=State.patients.find(i=>i.id===State.editId);
            p.addedDate=x.addedDate;
            p.orderStatus=x.orderStatus;
            p.arrivedDate=x.arrivedDate;
            p.deliveredDate=x.deliveredDate;
            p.reminderSent=x.reminderSent;
            p.reminderDate=x.reminderDate;
            p.converted=x.converted;
            p.convertedDate=x.convertedDate;
            p.history=x.history||[];
            State.patients[State.patients.findIndex(i=>i.id===State.editId)]=p;
        }else{
            State.patients.push(p);
        }
        
        await API.savePatient(p,State.editId?'update':'add');
        UI.showToast(State.editId?'Updated!':'Added!','success');
        renderPatients();
        UI.updateOrdersBadge();
        resetForm();
        btn.disabled=false;
        btn.innerHTML='<span>‚ûï</span> Add '+(t==='refill'?'Patient':'Order');
    },
    
    edit(id){
        const p=State.patients.find(x=>x.id===id);
        if(!p)return;
        State.editId=id;
        setEntryType(p.type||'refill');
        document.getElementById('name').value=p.name;
        document.getElementById('phone').value=p.phone;
        document.getElementById('med').value=p.med;
        document.getElementById('notes').value=p.notes||'';
        
        if(p.type==='refill'){
            document.getElementById('date').value=p.date;
            document.getElementById('days').value=p.days;
        } else {
            document.getElementById('branch').value=p.branch;
            if(p.pickupDate===Utils.getToday())document.getElementById('pickupDate').value='today';
            else if(p.pickupDate===Utils.getTomorrow())document.getElementById('pickupDate').value='tomorrow';
            else if(p.pickupDate){
                document.getElementById('pickupDate').value='custom';
                document.getElementById('customPickupDate').value=p.pickupDate;
                document.getElementById('customDateGroup').style.display='block';
            }
        }
        document.getElementById('formTitle').textContent='‚úèÔ∏è Edit';
        document.getElementById('submitBtn').innerHTML='<span>üíæ</span> Update';
        window.scrollTo({top:0,behavior:'smooth'});
    },
    
    delete(id){
        const p=State.patients.find(x=>x.id===id);
        UI.showModal({
            icon:'üóëÔ∏è',
            title:'Delete',
            message:'Delete "'+(p.name || p.phone)+'"?',
            confirmText:'Delete',
            confirmClass:'danger',
            onConfirm:async()=>{
                State.patients=State.patients.filter(x=>x.id!==id);
                await API.savePatient({id},'delete');
                UI.showToast('Deleted!','success');
                renderPatients();
                UI.updateOrdersBadge();
            }
        });
    },
    
    confirmWhatsApp(id){
        const p=State.patients.find(x=>x.id===id);
        UI.showModal({
            icon:'üì±',
            title:'Send WhatsApp',
            message:'Send reminder to "'+(p.name || p.phone)+'"?',
            confirmText:'Send',
            confirmClass:'success',
            onConfirm:()=>this.sendRefillWhatsApp(id)
        });
    },
    
    sendRefillWhatsApp(id){
        const p=State.patients.find(x=>x.id===id);
        if(!p)return;
        const m='ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá\nÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä ÿßŸÑÿ±ÿ≥ 1 ÿ™ÿ±ÿ≠ÿ® ÿ®ŸÉŸÖ\n\nŸáÿ∞ÿß ÿ™ÿ∞ŸÉŸäÿ± ÿ®ŸÖŸàÿπÿØ ÿµÿ±ŸÅ ÿßŸÑÿØŸàÿßÿ° ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:\n\nÿßŸÑÿØŸàÿßÿ°: '+p.med+'\n\nŸÜÿ≥ÿπÿØ ÿ®ÿ™ÿ¨ŸáŸäÿ≤Ÿá ŸÑŸÉŸÖ ÿπÿ®ÿ±:\n\n- ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÖŸÜ ÿßŸÑÿµŸäÿØŸÑŸäÿ©\n- ÿßŸÑÿ™ŸàÿµŸäŸÑ ŸÑŸÖŸàŸÇÿπŸÉŸÖ\n\nüìç ŸÖŸàŸÇÿπ ÿßŸÑÿµŸäÿØŸÑŸäÿ©:\nhttps://shorturl.at/M2Cq3\n\nŸÜÿ™ŸÖŸÜŸâ ŸÑŸÉŸÖ ÿØŸàÿßŸÖ ÿßŸÑÿµÿ≠ÿ© ŸàÿßŸÑÿπÿßŸÅŸäÿ©';
        window.open('https://wa.me/'+p.phone+'?text='+encodeURIComponent(m),'_blank');
        p.reminderSent='yes';
        p.reminderDate=Utils.getToday();
        API.savePatient(p,'update');
        UI.showToast('WhatsApp opened!','success');
        renderPatients();
        renderTracking();
    },
    
    confirmArrived(id){
        const p=State.patients.find(x=>x.id===id);
        UI.showModal({
            icon:'üì•',
            title:'Order Arrived',
            message:'Send WhatsApp to "'+(p.name || p.phone)+'"?',
            confirmText:'Yes, Send',
            confirmClass:'success',
            onConfirm:()=>this.markArrived(id)
        });
    },
    
    async markArrived(id){
        const p=State.patients.find(x=>x.id===id);
        p.orderStatus='pending';
        p.arrivedDate=Utils.getToday();
        const m='ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá\nÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä ÿßŸÑÿ±ÿ≥ 1\n\nÿ∑ŸÑÿ®ŸÉŸÖ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ‚úÖ\n\nÿßŸÑÿØŸàÿßÿ°: '+p.med+'\n\nüìç ŸÖŸàŸÇÿπ ÿßŸÑÿµŸäÿØŸÑŸäÿ©:\nhttps://shorturl.at/M2Cq3\n\nŸÜÿ≥ÿπÿØ ÿ®ÿÆÿØŸÖÿ™ŸÉŸÖ';
        window.open('https://wa.me/'+p.phone+'?text='+encodeURIComponent(m),'_blank');
        await API.savePatient(p,'update');
        UI.showToast('WhatsApp opened!','success');
        renderPatients();
        UI.updateOrdersBadge();
    },
    
    async markDelivered(id){
        const p=State.patients.find(x=>x.id===id);
        p.orderStatus='delivered';
        p.deliveredDate=Utils.getToday();
        await API.savePatient(p,'update');
        UI.showToast('Delivered!','success');
        renderPatients();
        UI.updateOrdersBadge();
    },
    
    async markConverted(id){
        const p=State.patients.find(x=>x.id===id);
        p.converted='yes';
        p.convertedDate=Utils.getToday();
        await API.savePatient(p,'update');
        UI.showToast('Converted!','success');
        renderPatients();
        renderTracking();
    },
    
    async undoConverted(id){
        const p=State.patients.find(x=>x.id===id);
        p.converted='no';
        p.convertedDate='';
        await API.savePatient(p,'update');
        UI.showToast('Undone','info');
        renderTracking();
    },
    
    async renewPatient(id){
        const p=State.patients.find(x=>x.id===id);
        if(!p.history)p.history=[];
        p.history.push({date:p.date,reminderDate:p.reminderDate,convertedDate:p.convertedDate});
        p.date=Utils.getToday();
        p.reminderSent='no';
        p.reminderDate='';
        p.converted='no';
        p.convertedDate='';
        await API.savePatient(p,'update');
        UI.showToast('Renewed!','success');
        renderPatients();
        renderTracking();
    }
};

// ==================== ORDERS MODULE (Quick List) ====================
const OrdersModule = {
    addItem(e) {
        e.preventDefault();
        UI.clearFieldErrors();
        const med = document.getElementById('orderMed').value.trim();
        const qty = parseInt(document.getElementById('orderQty').value) || 1;
        const branch = document.getElementById('orderBranch').value;
        const isClient = document.getElementById('orderClient').checked;
        if (!med) { UI.showFieldError('orderMed', true); return; }
        if (!branch) { UI.showFieldError('orderBranch', true); return; }
        State.orderItems.push({id: Date.now(), med: med, qty: qty, branch: branch, isClient: isClient});
        document.getElementById('orderMed').value = '';
        document.getElementById('orderQty').value = '1';
        document.getElementById('orderClient').checked = false;
        this.renderOrders();
        UI.showToast('Added to list', 'success');
    },
    removeItem(id) { State.orderItems = State.orderItems.filter(item => item.id !== id); this.renderOrders(); },
    clearAll() { if (State.orderItems.length === 0) return; UI.showModal({icon: 'üóëÔ∏è', title: 'Clear All', message: 'Remove all items?', confirmText: 'Clear', confirmClass: 'danger', onConfirm: () => { State.orderItems = []; this.renderOrders(); }}); },
    renderOrders() {
        const c = document.getElementById('ordersList');
        const ss = document.getElementById('sendSection');
        const cb = document.getElementById('clearAllBtn');
        if (State.orderItems.length === 0) { c.innerHTML = '<div class="empty">No items</div>'; ss.style.display = 'none'; cb.style.display = 'none'; return; }
        cb.style.display = 'inline-flex';
        c.innerHTML = State.orderItems.map(item => `<div class="order-item"><div class="order-item-info"><div class="order-item-med">${Utils.sanitize(item.med)} ${item.isClient?'<span class="badge badge-client">ŸÑÿπŸÖŸäŸÑ</span>':''}</div><div class="order-item-details">Qty: ${item.qty}</div><div class="order-item-branch">From: ${item.branch}</div></div><button class="order-item-del" onclick="OrdersModule.removeItem(${item.id})">üóëÔ∏è</button></div>`).join('');
        ss.style.display = 'block';
        const grouped = {};
        State.orderItems.forEach(item => { if (!grouped[item.branch]) grouped[item.branch] = []; grouped[item.branch].push(item); });
        document.getElementById('groupedOrders').innerHTML = Object.entries(grouped).map(([branch, items]) => `<div class="send-group"><div class="send-group-header"><span class="send-group-title">üìç ${branch}</span><span class="send-group-count">${items.length} items</span></div><div class="send-group-items">${items.map(item => `<div class="send-group-item ${item.isClient?'client':''}">‚Ä¢ ${Utils.sanitize(item.med)} - Qty: ${item.qty}</div>`).join('')}</div><button class="btn btn-info btn-sm" onclick="OrdersModule.sendEmail('${branch}')" style="margin-top:10px">üìß Send to ${branch}</button></div>`).join('');
    },
    sendEmail(branch) {
        const items = State.orderItems.filter(item => item.branch === branch);
        if (items.length === 0) return;
        const email = BRANCH_EMAILS[branch];
        const subject = `ÿ∑ŸÑÿ® ÿ™ÿ≠ŸàŸäŸÑ ÿ£ÿµŸÜÿßŸÅ - ÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿ≥ 1`;
        let body = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ\n\nŸÜÿ±ÿ¨Ÿà ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿµŸÜÿßŸÅ ÿßŸÑÿ™ÿßŸÑŸäÿ©:\n\n`;
        items.forEach(item => { body += `‚Ä¢ ${item.med} - ÿßŸÑŸÉŸÖŸäÿ©: ${item.qty}${item.isClient ? ' (ŸÑÿπŸÖŸäŸÑ)' : ''}\n`; });
        body += `\nŸàÿ¨ÿ≤ÿßŸÉŸÖ ÿßŸÑŸÑŸá ÿÆŸäÿ±ÿßŸã\nÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä - ÿßŸÑÿ±ÿ≥ 1`;
        window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
    },
    sendAllEmails() {
        const branches = [...new Set(State.orderItems.map(item => item.branch))];
        branches.forEach((branch, index) => { setTimeout(() => { this.sendEmail(branch); }, index * 500); });
    }
};

function checkTodayAlerts(){
    const t=Utils.getToday();
    const o=State.patients.filter(p=>p.type==='order'&&p.orderStatus!=='delivered'&&p.pickupDate===t).length;
    const r=State.patients.filter(p=>p.type==='refill'&&Utils.getDaysUntilRefill(p)<0).length;
    let m=[];
    if(o>0)m.push(o+' orders for today');
    if(r>0)m.push(r+' overdue refills');
    if(m.length>0)UI.showAlert('üîî '+m.join(' ‚Ä¢ '));
}

function renderPatients(){
    const s=State.searchQuery.toLowerCase(), tf=State.typeFilter, sf=State.statusFilter;
    let f=State.patients.filter(p=>{
        const ms=p.name.toLowerCase().includes(s)||p.med.toLowerCase().includes(s)||p.phone.includes(s);
        if(!ms)return false;
        if(tf!=='all'&&p.type!==tf)return false;
        if(sf!=='all'){
            if(p.type==='refill'){
                const d=Utils.getDaysUntilRefill(p);
                if(sf==='overdue'&&d>=0)return false;
                if(sf==='soon'&&(d<0||d>2))return false;
                if(sf==='ok'&&d<=2)return false;
                if(sf==='waiting'||sf==='pending')return false;
            } else {
                if(sf==='waiting'&&p.orderStatus!=='waiting')return false;
                if(sf==='pending'&&p.orderStatus!=='pending')return false;
                if(['overdue','soon','ok'].includes(sf))return false;
            }
        }
        return true;
    });
    
    f.sort((a,b)=>{
        if(a.type==='order'&&b.type==='refill')return -1;
        if(a.type==='refill'&&b.type==='order')return 1;
        if(a.type==='order')return new Date(a.addedDate)-new Date(b.addedDate);
        return Utils.getRefillDate(a)-Utils.getRefillDate(b);
    });
    
    let w=0,o=0,po=0;
    State.patients.forEach(p=>{
        if(p.type==='refill'){
            const d=Utils.getDaysUntilRefill(p);
            if(d<0)o++;
            else if(d<=2)w++;
        } else if(p.type==='order'&&p.orderStatus!=='delivered')po++;
    });
    
    document.getElementById('total').textContent=State.patients.length;
    document.getElementById('warn').textContent=w;
    document.getElementById('over').textContent=o;
    document.getElementById('pendingOrders').textContent=po;
    
    const tp=Math.ceil(f.length/CONFIG.ITEMS_PER_PAGE);
    State.currentPage=Math.min(State.currentPage,tp||1);
    const si=(State.currentPage-1)*CONFIG.ITEMS_PER_PAGE;
    const pg=f.slice(si,si+CONFIG.ITEMS_PER_PAGE);
    
    const tb=document.getElementById('patientsTbody');
    if(pg.length===0){
        tb.innerHTML='<tr><td colspan="7"><div class="empty">No records found</div></td></tr>';
        document.getElementById('pagination').innerHTML='';
        return;
    }
    
    tb.innerHTML=pg.map(p=>{
        const io=p.type==='order';
        let st,sc,dd;
        if(io){
            if(p.orderStatus==='delivered'){st='‚úÖ Delivered';sc='delivered'}
            else if(p.orderStatus==='pending'){st='‚è≥ Pending';sc='waiting'}
            else{st='üîµ Waiting';sc='info'}
            dd=p.pickupDate?Utils.formatDisplayDate(p.pickupDate):'-';
        }else{
            const d=Utils.getDaysUntilRefill(p);
            dd=Utils.getRefillDate(p).toLocaleDateString('en-US',{month:'short',day:'numeric'});
            if(d<0){st='Overdue '+Math.abs(d)+'d';sc='danger'}
            else if(d<=2){st=d+'d left';sc='warn'}
            else{st=d+'d left';sc='ok'}
        }
        
        const ad=Utils.formatDisplayDate(p.addedDate);
        const hc=(p.history||[]).length;
        const hb=hc>0?' <span class="badge badge-ok">'+hc+'</span>':'';
        let ac='';
        if(io){
            if(p.orderStatus==='waiting')ac='<button class="arrived" onclick="PatientActions.confirmArrived(\''+p.id+'\')" title="Arrived">üì•</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">‚úèÔ∏è</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">üóëÔ∏è</button>';
            else if(p.orderStatus==='pending')ac='<button class="done" onclick="PatientActions.markDelivered(\''+p.id+'\')" title="Delivered">‚úÖ</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">‚úèÔ∏è</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">üóëÔ∏è</button>';
            else ac='<button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">‚úèÔ∏è</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">üóëÔ∏è</button>';
        }else{
            ac='<button class="wa" onclick="PatientActions.confirmWhatsApp(\''+p.id+'\')" title="WhatsApp">'+WA_ICON+'</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">‚úèÔ∏è</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">üóëÔ∏è</button>';
        }
        
        return `<tr class="${io?'order-row':''}">
            <td><span class="type-badge">${io?'üì¶':'üíä'}</span></td>
            <td><div class="name">${Utils.sanitize(p.name)}${hb}</div><div class="phone"><span class="phone-copy" onclick="Utils.copyToClipboard('${p.phone}')" title="Copy">üìã</span>${Utils.sanitize(p.phone)}</div>${io&&p.branch?'<div class="branch-info">From: '+p.branch+'</div>':''}</td>
            <td><div class="med">${Utils.sanitize(p.med)}</div>${p.notes?'<div class="phone">'+Utils.sanitize(p.notes)+'</div>':''}</td>
            <td><span class="date-added">${ad}</span></td>
            <td>${dd}</td>
            <td><span class="badge badge-${sc}">${st}</span></td>
            <td><div class="actions">${ac}</div></td>
        </tr>`;
    }).join('');
    
    renderPagination(tp,f.length);
}

function renderPagination(tp,ti){
    const pg=document.getElementById('pagination');
    if(tp<=1){pg.innerHTML='';return}
    let h='<button onclick="changePage(1)" '+(State.currentPage===1?'disabled':'')+'>¬´</button><button onclick="changePage('+(State.currentPage-1)+')" '+(State.currentPage===1?'disabled':'')+'>‚Äπ</button>';
    const mv=5;
    let st=Math.max(1,State.currentPage-Math.floor(mv/2));
    let en=Math.min(tp,st+mv-1);
    if(en-st+1<mv)st=Math.max(1,en-mv+1);
    for(let i=st;i<=en;i++)h+='<button onclick="changePage('+i+')" class="'+(i===State.currentPage?'active':'')+'">'+i+'</button>';
    h+='<button onclick="changePage('+(State.currentPage+1)+')" '+(State.currentPage===tp?'disabled':'')+'>‚Ä∫</button><button onclick="changePage('+tp+')" '+(State.currentPage===tp?'disabled':'')+'>¬ª</button><span class="pagination-info">'+ti+' records</span>';
    pg.innerHTML=h;
}

function changePage(p){State.currentPage=p;renderPatients()}

function renderTracking(){
    const fl=document.getElementById('trackFilter').value;
    let l=State.patients.filter(p=>p.type==='refill'&&p.reminderSent==='yes');
    if(fl==='waiting')l=l.filter(p=>p.converted!=='yes');
    else if(fl==='converted')l=l.filter(p=>p.converted==='yes');
    l.sort((a,b)=>new Date(b.reminderDate)-new Date(a.reminderDate));
    
    let ts=0,tc=0;
    State.patients.filter(p=>p.type==='refill').forEach(p=>{
        if(p.reminderSent==='yes')ts++;
        if(p.converted==='yes')tc++;
        (p.history||[]).forEach(h=>{if(h.reminderDate)ts++;if(h.convertedDate)tc++});
    });
    
    document.getElementById('tSent').textContent=ts;
    document.getElementById('tConverted').textContent=tc;
    document.getElementById('tRate').textContent=ts>0?Math.round(tc/ts*100)+'%':'0%';
    
    const g=document.getElementById('trackGrid');
    if(l.length===0){g.innerHTML='<div class="empty" style="grid-column:1/-1">No records</div>';return}
    g.innerHTML=l.map(p=>{
        const hc=(p.history||[]).length;
        const hb=hc>0?'<div class="history-badge">üîÑ '+hc+'</div>':'';
        if(p.converted==='yes'){
            return `<div class="track-card converted">${hb}<div class="name">${Utils.sanitize(p.name)}</div><div class="phone">${Utils.sanitize(p.phone)}</div><div class="med">${Utils.sanitize(p.med)}</div><div class="info">üì§ ${p.reminderDate}<br>‚úÖ ${p.convertedDate}</div><button class="track-btn done" onclick="PatientActions.undoConverted('${p.id}')">‚úÖ Converted (Undo)</button><button class="track-btn renew" onclick="PatientActions.renewPatient('${p.id}')">üîÑ Renew</button></div>`;
        }else{
            return `<div class="track-card">${hb}<div class="name">${Utils.sanitize(p.name)}</div><div class="phone">${Utils.sanitize(p.phone)}</div><div class="med">${Utils.sanitize(p.med)}</div><div class="info">üì§ ${p.reminderDate}</div><button class="track-btn" onclick="PatientActions.markConverted('${p.id}')">‚úÖ Mark Converted</button></div>`;
        }
    }).join('');
}

function generateReport(){
    const m=parseInt(document.getElementById('reportMonth').value);
    const y=parseInt(document.getElementById('reportYear').value);
    generateRefillReport(m,y);
    generateOrdersReport(m,y);
}

function generateRefillReport(m,y){
    let s=0,c=0;
    const cp=[];
    State.patients.filter(p=>p.type==='refill').forEach(p=>{
        if(p.reminderSent==='yes'&&p.reminderDate){
            const rd=new Date(p.reminderDate);
            if(rd.getMonth()===m&&rd.getFullYear()===y){
                s++;
                if(p.converted==='yes'){c++;cp.push({name:p.name,phone:p.phone,med:p.med,reminderDate:p.reminderDate,convertedDate:p.convertedDate});}
            }
        }
        (p.history||[]).forEach(h=>{
            if(h.reminderDate){
                const rd=new Date(h.reminderDate);
                if(rd.getMonth()===m&&rd.getFullYear()===y){
                    s++;
                    if(h.convertedDate){c++;cp.push({name:p.name,phone:p.phone,med:p.med,reminderDate:h.reminderDate,convertedDate:h.convertedDate});}
                }
            }
        });
    });
    const r=s>0?Math.round(c/s*100):0;
    const w=s-c;
    const wr=s>0?Math.round(w/s*100):0;
    document.getElementById('rSent').textContent=s;
    document.getElementById('rConverted').textContent=c;
    document.getElementById('rRate').textContent=r+'%';
    document.getElementById('rBar').style.width=r+'%';
    document.getElementById('summaryTb').innerHTML=`<tr><td>üì§ Sent</td><td>${s}</td><td>100%</td></tr><tr><td>‚úÖ Converted</td><td>${c}</td><td>${r}%</td></tr><tr><td>‚è≥ Waiting</td><td>${w}</td><td>${wr}%</td></tr>`;
    document.getElementById('convList').innerHTML=cp.length>0?cp.map(p=>`<tr><td class="name">${Utils.sanitize(p.name)}</td><td class="phone">${Utils.sanitize(p.phone)}</td><td class="med">${Utils.sanitize(p.med)}</td><td>${p.reminderDate}</td><td>${p.convertedDate}</td></tr>`).join(''):'<tr><td colspan="5"><div class="empty">No conversions</div></td></tr>';
}

function generateOrdersReport(m,y){
    let t=0,d=0;
    const bs={},mc={};
    State.patients.filter(p=>p.type==='order').forEach(p=>{
        const ad=new Date(p.addedDate);
        if(ad.getMonth()===m&&ad.getFullYear()===y){
            t++;
            if(!bs[p.branch])bs[p.branch]={total:0,delivered:0};
            bs[p.branch].total++;
            const mn=p.med.toLowerCase().trim();
            mc[mn]=(mc[mn]||0)+1;
            if(p.orderStatus==='delivered'){d++;bs[p.branch].delivered++}
        }
    });
    const nd=t-d;
    const r=t>0?Math.round(d/t*100):0;
    document.getElementById('oTotal').textContent=t;
    document.getElementById('oDelivered').textContent=d;
    document.getElementById('oNotDelivered').textContent=nd;
    document.getElementById('oRate').textContent=r+'%';
    document.getElementById('oBar').style.width=r+'%';
    const br=Object.entries(bs).sort((a,b)=>b[1].total-a[1].total).map(([b,s])=>`<tr><td><strong>${b}</strong></td><td>${s.total}</td><td>${s.delivered}</td><td>${s.total-s.delivered}</td></tr>`).join('');
    document.getElementById('branchSummary').innerHTML=br||'<tr><td colspan="4"><div class="empty">No orders</div></td></tr>';
    const tm=Object.entries(mc).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([med,cnt])=>`<tr><td class="med">${Utils.sanitize(med)}</td><td>${cnt}</td></tr>`).join('');
    document.getElementById('topMeds').innerHTML=tm||'<tr><td colspan="2"><div class="empty">No orders</div></td></tr>';
}

function resetForm(){
    State.editId=null;
    document.getElementById('patientForm').reset();
    document.getElementById('days').value='30';
    document.getElementById('date').valueAsDate=new Date();
    document.getElementById('formTitle').textContent='‚ûï Add New';
    document.getElementById('submitBtn').innerHTML='<span>‚ûï</span> Add '+(State.entryType==='refill'?'Patient':'Order');
    document.getElementById('customDateGroup').style.display='none';
    UI.clearFieldErrors();
}

function showPage(n){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(n+'Page').classList.add('active');
    document.querySelector('[data-page="'+n+'"]').classList.add('active');
    if(n==='tracking')renderTracking();
    if(n==='reports')generateReport();
    if(n==='orders')OrdersModule.renderOrders();
}

// Global exports
window.PatientActions=PatientActions;
window.OrdersModule=OrdersModule;
window.Utils=Utils;
window.UI=UI;
window.changePage=changePage;
window.resetForm=resetForm;
window.setEntryType=setEntryType;
window.showReportTab=showReportTab;

// Initialize
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('date').valueAsDate=new Date();
    
    // Report month/year
    const ms=document.getElementById('reportMonth');
    const ys=document.getElementById('reportYear');
    const cd=new Date();
    CONFIG.MONTHS.forEach((m,i)=>{ms.innerHTML+='<option value="'+i+'">'+m+'</option>'});
    ms.value=cd.getMonth();
    for(let y=cd.getFullYear();y<=cd.getFullYear()+3;y++){ys.innerHTML+='<option value="'+y+'">'+y+'</option>'}
    ys.value=cd.getFullYear();
    
    // Event listeners
    document.querySelectorAll('.tab').forEach(t=>{
        t.addEventListener('click',()=>showPage(t.dataset.page));
    });
    
    document.getElementById('patientForm').addEventListener('submit',PatientActions.save);
    document.getElementById('orderForm').addEventListener('submit',(e)=>OrdersModule.addItem(e));
    document.getElementById('pickupDate').addEventListener('change',handlePickupDateChange);
    
    document.getElementById('search').addEventListener('input',Utils.debounce(e=>{
        State.searchQuery=e.target.value;
        State.currentPage=1;
        renderPatients();
    },CONFIG.SEARCH_DELAY));
    
    document.getElementById('typeFilter').addEventListener('change',e=>{
        State.typeFilter=e.target.value;
        State.currentPage=1;
        renderPatients();
    });
    
    document.getElementById('statusFilter').addEventListener('change',e=>{
        State.statusFilter=e.target.value;
        State.currentPage=1;
        renderPatients();
    });
    
    document.getElementById('trackFilter').addEventListener('change',renderTracking);
    document.getElementById('reportMonth').addEventListener('change',generateReport);
    document.getElementById('reportYear').addEventListener('change',generateReport);
    
    // Load data
    API.loadPatients();
    OrdersModule.renderOrders();
});
</script>

</body>
</html>
