Ù„Ø§ Ù…Ø§ÙŠØ­ØªØ§Ø¬ Ø¨Ø³ Ø¹Ù†Ø¯ÙŠ Ù…Ø´ÙƒÙ„Ø© Ø§Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ùˆ Ù‚Ø§Ø¹Ø¯ ÙŠÙ‚Ø±Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ·Ù„Ø¹ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰ 0

<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 1 Refill Cash Patients System</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        :root{--primary:#561C2C;--primary-light:#7a2840;--accent:#8DC63F;--accent-dark:#6fa329;--text-dark:#333;--gray:#666;--gray-light:#f5f5f5;--white:#fff;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--order-bg:#eff6ff;--shadow-sm:0 2px 4px rgba(0,0,0,0.05);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 25px rgba(0,0,0,0.1);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-full:9999px;--transition:0.3s ease}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(180deg,#f9f6f2 0%,#e8dccf 100%);color:var(--text-dark);min-height:100vh;padding:20px;line-height:1.6}
        .toast-container{position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px}
        .toast{padding:14px 20px;border-radius:var(--radius-md);color:white;font-weight:500;box-shadow:var(--shadow-lg);animation:slideIn .3s ease;display:flex;align-items:center;gap:10px;min-width:280px}
        .toast.hiding{animation:slideOut .3s ease forwards}
        .toast-success{background:var(--success)}.toast-error{background:var(--danger)}.toast-warning{background:var(--warning)}.toast-info{background:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;z-index:9999;opacity:0;visibility:hidden;transition:var(--transition)}
        .loading-overlay.active{opacity:1;visibility:visible}
        .spinner{width:50px;height:50px;border:4px solid var(--gray-light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{color:var(--primary);font-weight:600}
        @keyframes spin{to{transform:rotate(360deg)}}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9998;opacity:0;visibility:hidden;transition:var(--transition)}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:white;border-radius:var(--radius-lg);padding:30px;max-width:400px;width:90%;text-align:center;transform:scale(0.9);transition:var(--transition)}
        .modal-overlay.active .modal{transform:scale(1)}
        .modal-icon{font-size:48px;margin-bottom:15px}.modal-title{font-size:18px;font-weight:bold;color:var(--text-dark);margin-bottom:10px}.modal-message{color:var(--gray);margin-bottom:20px;line-height:1.6}
        .modal-actions{display:flex;gap:10px;justify-content:center}
        .modal-actions button{padding:10px 24px;border-radius:var(--radius-sm);font-weight:bold;cursor:pointer;transition:var(--transition);border:none}
        .modal-cancel{background:#e5e5e5;color:var(--text-dark)}.modal-cancel:hover{background:#d5d5d5}
        .modal-confirm{background:var(--primary);color:white}.modal-confirm:hover{background:var(--primary-light)}
        .modal-confirm.danger{background:var(--danger)}.modal-confirm.danger:hover{background:#dc2626}
        .modal-confirm.success{background:var(--success)}.modal-confirm.success:hover{background:#059669}
        .container{max-width:1200px;margin:0 auto}
        .header-container{text-align:center;margin-bottom:25px}
        .logo-img{height:90px;margin-bottom:15px;filter:drop-shadow(0 2px 4px rgba(86,28,44,0.2))}
        h1{color:var(--primary);margin-bottom:10px;font-weight:700}
        .tabs{display:flex;justify-content:center;gap:10px;margin-bottom:25px;flex-wrap:wrap}
        .tab{background:rgba(255,255,255,0.7);border:none;padding:12px 30px;border-radius:var(--radius-full);cursor:pointer;font-weight:bold;color:var(--gray);transition:var(--transition);box-shadow:var(--shadow-sm);position:relative}
        .tab.active{background:var(--primary);color:white;box-shadow:0 4px 10px rgba(86,28,44,0.3)}
        .tab:hover:not(.active){background:white;transform:translateY(-2px)}
        .tab-badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;font-size:11px;font-weight:bold;padding:2px 6px;border-radius:var(--radius-full);min-width:20px}
        .page{display:none;animation:fadeIn .3s ease}.page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
        .grid{display:grid;grid-template-columns:350px 1fr;gap:20px}
        @media(max-width:900px){.grid{grid-template-columns:1fr}}
        .card{background:var(--white);border-radius:var(--radius-lg);padding:25px;margin-bottom:20px;box-shadow:var(--shadow-lg)}
        .card-title{color:var(--primary);margin-bottom:20px;font-size:18px;font-weight:600}
        .type-selector{display:flex;gap:10px;margin-bottom:20px}
        .type-btn{flex:1;padding:15px;border:2px solid #e5e5e5;border-radius:var(--radius-md);background:white;cursor:pointer;transition:var(--transition);text-align:center}
        .type-btn:hover{border-color:var(--primary)}
        .type-btn.active{border-color:var(--primary);background:rgba(86,28,44,0.05)}
        .type-btn.active.order{border-color:var(--info);background:var(--order-bg)}
        .type-btn-icon{font-size:24px;margin-bottom:5px}.type-btn-label{font-weight:600;color:var(--text-dark)}.type-btn-desc{font-size:12px;color:var(--gray)}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;color:#555;font-size:14px;font-weight:600}
        label .required{color:var(--danger)}
        input,select{width:100%;padding:12px;background:#fafafa;border:2px solid #e5e5e5;border-radius:var(--radius-sm);color:#333;font-size:14px;transition:var(--transition)}
        input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(86,28,44,0.1);background:white}
        input.error{border-color:var(--danger);background:#fef2f2}
        .error-message{color:var(--danger);font-size:12px;margin-top:4px;display:none}.error-message.show{display:block}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .btn{padding:12px 20px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:bold;width:100%;margin-top:10px;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:var(--primary);color:white}.btn-primary:hover:not(:disabled){background:var(--primary-light);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .btn-secondary{background:#6c757d;color:white}.btn-secondary:hover:not(:disabled){background:#5a6268}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important}
        .btn-sm{padding:8px 16px;width:auto;margin:0}
        .filters-row{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .filters-row input{flex:1;min-width:200px}.filters-row select{width:auto;min-width:130px}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px}
        th{text-align:left;padding:15px;background:#f9f9f9;color:var(--gray);font-size:12px;text-transform:uppercase;border-bottom:2px solid #eee;white-space:nowrap}
        td{padding:15px;border-bottom:1px solid #eee;vertical-align:middle}
        tr:hover{background:#fcfcfc}
        tr.order-row{background:var(--order-bg)}tr.order-row:hover{background:#e0edff}
        .name{font-weight:bold;color:var(--primary)}
        .phone{color:#888;font-size:13px;margin-top:2px;display:flex;align-items:center;gap:5px}
        .phone-copy{cursor:pointer;padding:2px 5px;border-radius:4px;transition:var(--transition)}.phone-copy:hover{background:#e5e5e5}
        .med{color:var(--primary);font-weight:500}
        .branch{color:var(--info);font-size:12px;font-weight:500}
        .date-added{color:#888;font-size:12px}
        .badge{padding:6px 14px;border-radius:var(--radius-full);font-size:11px;font-weight:bold;letter-spacing:0.5px;white-space:nowrap}
        .badge-ok{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .badge-warn{background:rgba(245,158,11,0.15);color:#d97706}
        .badge-danger{background:rgba(239,68,68,0.15);color:#dc2626}
        .badge-info{background:rgba(59,130,246,0.15);color:var(--info)}
        .badge-waiting{background:rgba(245,158,11,0.15);color:#d97706}
        .badge-delivered{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .type-badge{font-size:16px;margin-right:5px}
        .actions{display:flex;gap:6px;flex-wrap:wrap}
        .actions button{width:34px;height:34px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:var(--transition);display:flex;align-items:center;justify-content:center}
        .wa{background:#25D366;color:white}.edit{background:rgba(86,28,44,0.1);color:var(--primary)}.del{background:rgba(239,68,68,0.1);color:#ef4444}
        .arrived{background:rgba(59,130,246,0.15);color:var(--info)}.done{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .actions button:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm)}
        .empty{text-align:center;padding:50px;color:#aaa;font-style:italic}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px}
        .stat{background:white;padding:20px;border-radius:var(--radius-md);box-shadow:var(--shadow-md);position:relative;overflow:hidden}
        .stat::after{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--gray)}
        .stat-num{font-size:28px;font-weight:800;color:var(--text-dark)}.stat-label{color:#888;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;margin-top:5px}
        .stat.total::after{background:var(--primary)}.stat.w::after{background:#f59e0b}.stat.d::after{background:#ef4444}.stat.s::after{background:var(--accent)}.stat.orders::after{background:var(--info)}
        .sync{text-align:center;padding:10px 16px;font-size:13px;margin-bottom:15px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;gap:8px}
        .sync-ok{color:var(--accent-dark);border:1px solid rgba(141,198,63,0.3)}.sync-err{color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
        .alert-banner{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border:1px solid #f59e0b;border-radius:var(--radius-md);padding:15px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px;animation:fadeIn .3s ease}
        .alert-banner.hidden{display:none}.alert-banner-icon{font-size:24px}.alert-banner-text{flex:1;font-weight:500;color:#92400e}.alert-banner-close{background:none;border:none;font-size:20px;cursor:pointer;color:#92400e;padding:5px}
        .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px;flex-wrap:wrap}
        .pagination button{padding:8px 14px;border:1px solid #ddd;background:white;border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition);font-weight:500}
        .pagination button:hover:not(:disabled):not(.active){border-color:var(--primary);color:var(--primary)}
        .pagination button.active{background:var(--primary);color:white;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        .pagination-info{color:var(--gray);font-size:13px;margin-left:10px}
        .track-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px}
        .track-card{background:white;border:2px solid #eee;border-radius:var(--radius-md);padding:20px;transition:var(--transition);box-shadow:var(--shadow-sm)}
        .track-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .track-card.converted{border-color:var(--accent);background:rgba(141,198,63,0.05)}
        .track-card .name{font-size:16px;margin-bottom:5px;color:#333}.track-card .med{margin:10px 0;color:var(--primary);font-size:14px}.track-card .info{font-size:12px;color:#888;margin-bottom:15px;line-height:1.5}
        .track-card .history-badge{font-size:11px;color:var(--accent-dark);background:rgba(141,198,63,0.1);padding:4px 8px;border-radius:10px;margin-bottom:10px;display:inline-block}
        .track-btn{width:100%;padding:12px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:bold;font-size:14px;background:rgba(141,198,63,0.15);color:var(--accent-dark);transition:var(--transition);margin-bottom:8px}
        .track-btn:hover{background:var(--accent);color:white}.track-btn.done{background:var(--accent);color:white}
        .track-btn.renew{background:rgba(86,28,44,0.1);color:var(--primary)}.track-btn.renew:hover{background:var(--primary);color:white}
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:25px}
        .report-card{background:var(--white);border-radius:var(--radius-md);padding:25px;text-align:center;box-shadow:var(--shadow-lg)}
        .report-value{font-size:42px;font-weight:bold;color:var(--primary)}.report-label{font-size:13px;color:#888;margin-top:5px}
        .progress{height:10px;background:#eee;border-radius:6px;margin-top:15px;overflow:hidden}
        .progress-bar{height:100%;border-radius:6px;transition:width .5s ease}
        .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .report-tabs{display:flex;gap:5px;margin-bottom:20px}
        .report-tab{padding:10px 20px;border:none;background:#f0f0f0;border-radius:var(--radius-sm) var(--radius-sm) 0 0;cursor:pointer;font-weight:600;color:var(--gray);transition:var(--transition)}
        .report-tab.active{background:white;color:var(--primary)}.report-tab:hover:not(.active){background:#e5e5e5}
        .report-section{display:none}.report-section.active{display:block}
        @media(max-width:600px){body{padding:10px}.header-container h1{font-size:18px}.logo-img{height:60px}.tabs{gap:5px}.tab{padding:10px 12px;font-size:12px}.card{padding:15px}.stats{grid-template-columns:1fr 1fr;gap:10px}.stat{padding:15px}.stat-num{font-size:22px}.stat-label{font-size:10px}table{font-size:12px}th,td{padding:10px 8px}.actions{gap:4px}.actions button{width:30px;height:30px;font-size:12px}.badge{padding:4px 8px;font-size:10px}.report-grid{grid-template-columns:1fr 1fr}.report-value{font-size:32px}.track-grid{grid-template-columns:1fr}.btn{padding:10px 15px}.header-row{flex-direction:column;align-items:stretch}input,select{padding:10px;font-size:16px}.row{grid-template-columns:1fr!important}.filters-row{flex-direction:column}.filters-row select{width:100%}.toast{min-width:auto;width:calc(100vw - 40px)}.type-selector{flex-direction:column}}
        @media print{body{background:white}.tabs,.sync,.header-row button,.actions,.pagination,.filters-row select,.type-selector,.alert-banner{display:none!important}.card{box-shadow:none;border:1px solid #ddd}}
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text">Loading...</div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal"><div class="modal-icon" id="modalIcon">âš ï¸</div><div class="modal-title" id="modalTitle">Confirm</div><div class="modal-message" id="modalMessage">Are you sure?</div><div class="modal-actions"><button class="modal-cancel" onclick="UI.closeModal()">Cancel</button><button class="modal-confirm" id="modalConfirm">Confirm</button></div></div></div>
    <div class="container">
        <div class="header-container"><img src="logo.png" alt="Rass 1" class="logo-img" onerror="this.style.display='none'"><h1>Rass 1 Refill Cash Patients System</h1></div>
        <div class="tabs"><button class="tab active" data-page="patients">ğŸ“‹ Patients</button><button class="tab" data-page="tracking">ğŸ“Š Tracking</button><button class="tab" data-page="reports">ğŸ“ˆ Reports</button></div>
        <div id="sync" class="sync sync-ok">âœ“ Connected to Google Sheets</div>
        <div class="alert-banner hidden" id="alertBanner"><span class="alert-banner-icon">ğŸ””</span><span class="alert-banner-text" id="alertText"></span><button class="alert-banner-close" onclick="document.getElementById('alertBanner').classList.add('hidden')">Ã—</button></div>
        <div id="patientsPage" class="page active">
            <div class="stats"><div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Total</div></div><div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Need Reminder</div></div><div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Overdue</div></div><div class="stat orders"><div class="stat-num" id="pendingOrders">0</div><div class="stat-label">ğŸ“¦ Pending</div></div></div>
            <div class="grid">
                <div class="card">
                    <h3 class="card-title" id="formTitle">â• Add New</h3>
                    <div class="type-selector"><button type="button" class="type-btn active refill" data-type="refill" onclick="setEntryType('refill')"><div class="type-btn-icon">ğŸ’Š</div><div class="type-btn-label">Refill</div><div class="type-btn-desc">Ù…Ø±ÙŠØ¶ Ù…ØªØ§Ø¨Ø¹Ø©</div></button><button type="button" class="type-btn order" data-type="order" onclick="setEntryType('order')"><div class="type-btn-icon">ğŸ“¦</div><div class="type-btn-label">Order</div><div class="type-btn-desc">Ø·Ù„Ø¨ Ù…Ù† ÙØ±Ø¹</div></button></div>
                    <form id="patientForm" novalidate>
                        <input type="hidden" id="entryType" value="refill">
                        <div class="form-group"><label>Customer Name (Optional)</label><input type="text" id="name" placeholder="Enter name"></div>
                        <div class="form-group"><label>Phone <span class="required">*</span></label><input type="tel" id="phone" placeholder="966512345678"><div class="error-message" id="phoneError">Please enter a valid phone</div></div>
                        <div class="form-group"><label>Medication <span class="required">*</span></label><input type="text" id="med" placeholder="Medication name"><div class="error-message" id="medError">Please enter medication</div></div>
                        <div id="refillFields"><div class="row"><div class="form-group"><label>Dispense Date <span class="required">*</span></label><input type="date" id="date"><div class="error-message" id="dateError">Please select date</div></div><div class="form-group"><label>Duration (days) <span class="required">*</span></label><input type="number" id="days" value="30" min="1" max="365"><div class="error-message" id="daysError">Enter 1-365</div></div></div></div>
                        <div id="orderFields" style="display:none"><div class="form-group"><label>From Branch <span class="required">*</span></label><select id="branch"><option value="">Select branch...</option><option>RASS2</option><option>RASS5</option><option>UNIZAH1</option><option>UNIZAH2</option><option>UNIZAH3</option><option>UNIZAH5</option><option>BADAYA1</option><option>BADAYA2</option><option>BADAYA3</option><option>BADAYA5</option><option>BADAYA.MOR</option><option>BUKAYRIAH1</option><option>BUKAYRIAH2</option><option>BUKAYRIAH.MOR</option><option>BURIDAH1</option><option>BURIDAH2</option><option>KHABRA1</option><option>MITHNAB1</option><option>MITHNAB2</option><option>RIYADH.KHABRA.MOR</option></select><div class="error-message" id="branchError">Please select branch</div></div><div class="form-group"><label>Pickup Date (Optional)</label><select id="pickupDate"><option value="">Not specified</option><option value="today">Today</option><option value="tomorrow">Tomorrow</option><option value="custom">Custom...</option></select></div><div class="form-group" id="customDateGroup" style="display:none"><label>Custom Date</label><input type="date" id="customPickupDate"></div></div>
                        <div class="form-group"><label>Notes</label><input type="text" id="notes" placeholder="Additional notes"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtn"><span>â•</span> Add</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Records</h3>
                    <div class="filters-row"><input type="text" id="search" placeholder="ğŸ” Search..."><select id="typeFilter"><option value="all">All Types</option><option value="refill">ğŸ’Š Refill</option><option value="order">ğŸ“¦ Orders</option></select><select id="statusFilter"><option value="all">All Status</option><option value="overdue">ğŸ”´ Overdue</option><option value="soon">ğŸŸ¡ Soon</option><option value="ok">ğŸŸ¢ OK</option><option value="waiting">ğŸ”µ Waiting</option><option value="pending">â³ Pending</option></select></div>
                    <div class="table-container"><table><thead><tr><th>Type</th><th>Customer</th><th>Medication</th><th>Added</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="patientsTbody"></tbody></table></div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>
        <div id="trackingPage" class="page">
            <div class="stats"><div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">Sent</div></div><div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">Converted</div></div><div class="stat" style="border-left:4px solid var(--primary)"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Rate</div></div></div>
            <div class="card"><div class="header-row"><h3 class="card-title" style="margin:0">ğŸ“Š Track Conversions</h3><select id="trackFilter" style="width:auto;min-width:150px"><option value="all">All</option><option value="waiting">â³ Waiting</option><option value="converted">âœ… Converted</option></select></div><div class="track-grid" id="trackGrid"></div></div>
        </div>
        <div id="reportsPage" class="page">
            <div class="card"><div class="header-row"><h3 class="card-title" style="margin:0">ğŸ“ˆ Monthly Report</h3><div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap"><select id="reportMonth" style="width:auto"></select><select id="reportYear" style="width:auto"></select><button class="btn btn-secondary btn-sm" onclick="window.print()">ğŸ–¨ï¸</button></div></div><div class="report-tabs"><button class="report-tab active" data-report="refill" onclick="showReportTab('refill')">ğŸ’Š Refill</button><button class="report-tab" data-report="orders" onclick="showReportTab('orders')">ğŸ“¦ Orders</button></div></div>
            <div id="refillReport" class="report-section active"><div class="report-grid"><div class="report-card"><div class="report-value" id="rSent">0</div><div class="report-label">ğŸ“¤ Sent</div></div><div class="report-card"><div class="report-value" style="color:var(--accent)" id="rConverted">0</div><div class="report-label">âœ… Converted</div></div><div class="report-card"><div class="report-value" style="color:var(--primary)" id="rRate">0%</div><div class="report-label">ğŸ“Š Rate</div><div class="progress"><div class="progress-bar" id="rBar" style="width:0%;background:var(--accent)"></div></div></div></div><div class="card"><h3 class="card-title">ğŸ“‹ Summary</h3><div class="table-container"><table><thead><tr><th>Metric</th><th>Count</th><th>%</th></tr></thead><tbody id="summaryTb"></tbody></table></div></div><div class="card"><h3 class="card-title">âœ… Converted</h3><div class="table-container"><table><thead><tr><th>Patient</th><th>Phone</th><th>Medication</th><th>Reminder</th><th>Converted</th></tr></thead><tbody id="convList"></tbody></table></div></div></div>
            <div id="ordersReport" class="report-section"><div class="report-grid"><div class="report-card"><div class="report-value" style="color:var(--info)" id="oTotal">0</div><div class="report-label">ğŸ“¦ Total</div></div><div class="report-card"><div class="report-value" style="color:var(--accent)" id="oDelivered">0</div><div class="report-label">âœ… Delivered</div></div><div class="report-card"><div class="report-value" style="color:var(--warning)" id="oNotDelivered">0</div><div class="report-label">â³ Pending</div></div><div class="report-card"><div class="report-value" style="color:var(--primary)" id="oRate">0%</div><div class="report-label">ğŸ“Š Rate</div><div class="progress"><div class="progress-bar" id="oBar" style="width:0%;background:var(--info)"></div></div></div></div><div class="card"><h3 class="card-title">ğŸ¢ By Branch</h3><div class="table-container"><table><thead><tr><th>Branch</th><th>Total</th><th>Delivered</th><th>Pending</th></tr></thead><tbody id="branchSummary"></tbody></table></div></div><div class="card"><h3 class="card-title">ğŸ’Š Top Medications</h3><div class="table-container"><table><thead><tr><th>Medication</th><th>Orders</th></tr></thead><tbody id="topMeds"></tbody></table></div></div></div>
        </div>
    </div>
<script>
// ==================== CONFIGURATION ====================
// âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ l5Rw/exec
const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbypBOv8BaBFExtpbOOH45z4vRMhlgqi1scWG7b0AGVECX573Pf54iEKOa1kFjqcSJl5Rw/exec',
    ITEMS_PER_PAGE: 10,
    SEARCH_DELAY: 300,
    TOAST_DURATION: 3000,
    PHONE_REGEX: /^(966|0)?5\d{8}$/,
    MONTHS: ['January','February','March','April','May','June','July','August','September','October','November','December']
};
// =======================================================

const State={patients:[],editId:null,currentPage:1,searchQuery:â€™â€™,typeFilter:â€˜allâ€™,statusFilter:â€˜allâ€™,entryType:â€˜refillâ€™,searchTimeout:null};
const Utils={
formatDate(v){if(!v)returnâ€™â€™;if(typeof v===â€˜stringâ€™&&/^\d{4}-\d{2}-\d{2}$/.test(v))return v;const d=new Date(v);if(isNaN(d))return v;return d.getFullYear()+â€™-â€™+String(d.getMonth()+1).padStart(2,â€˜0â€™)+â€™-â€™+String(d.getDate()).padStart(2,â€˜0â€™)},
formatDisplayDate(s){if(!s)returnâ€™-â€™;const d=new Date(s);if(isNaN(d))return s;return d.toLocaleDateString(â€˜en-USâ€™,{month:â€˜shortâ€™,day:â€˜numericâ€™})},
getToday(){const t=new Date();return t.getFullYear()+â€™-â€™+String(t.getMonth()+1).padStart(2,â€˜0â€™)+â€™-â€™+String(t.getDate()).padStart(2,â€˜0â€™)},
getTomorrow(){const t=new Date();t.setDate(t.getDate()+1);return t.getFullYear()+â€™-â€™+String(t.getMonth()+1).padStart(2,â€˜0â€™)+â€™-â€™+String(t.getDate()).padStart(2,â€˜0â€™)},
parseHistory(h){if(!h)return[];if(Array.isArray(h))return h;try{return JSON.parse(h)}catch(e){return[]}},
getRefillDate(p){const d=new Date(p.date);d.setDate(d.getDate()+parseInt(p.days||30));return d},
getDaysUntilRefill(p){const t=new Date();t.setHours(0,0,0,0);const r=this.getRefillDate(p);r.setHours(0,0,0,0);return Math.ceil((r-t)/(1000*60*60*24))},
sanitize(s){if(!s)returnâ€™â€™;const d=document.createElement(â€˜divâ€™);d.textContent=s;return d.innerHTML},
validatePhone(p){return CONFIG.PHONE_REGEX.test(p.replace(/\D/g,â€™â€™))},
formatPhone(p){let c=p.replace(/\D/g,â€™â€™);if(c.startsWith(â€˜0â€™))c=â€˜966â€™+c.substring(1);else if(!c.startsWith(â€˜966â€™))c=â€˜966â€™+c;return c},
debounce(f,d){return function(â€¦a){clearTimeout(State.searchTimeout);State.searchTimeout=setTimeout(()=>f.apply(this,a),d)}},
copyToClipboard(t){navigator.clipboard.writeText(t).then(()=>UI.showToast(â€˜Copied!â€™,â€˜successâ€™)).catch(()=>UI.showToast(â€˜Failedâ€™,â€˜errorâ€™))}
};
const UI={
showToast(m,t=â€˜infoâ€™){const c=document.getElementById(â€˜toastContainerâ€™);const e=document.createElement(â€˜divâ€™);e.className=â€˜toast toast-â€™+t;const i={success:â€˜âœ…â€™,error:â€˜âŒâ€™,warning:â€˜âš ï¸â€™,info:â€˜â„¹ï¸â€™};e.innerHTML=â€™<span>â€™+i[t]+â€™</span><span>â€™+m+â€™</span>â€™;c.appendChild(e);setTimeout(()=>{e.classList.add(â€˜hidingâ€™);setTimeout(()=>e.remove(),300)},CONFIG.TOAST_DURATION)},
setLoading(s,t=â€˜Loadingâ€¦â€™){const o=document.getElementById(â€˜loadingOverlayâ€™);o.querySelector(â€™.loading-textâ€™).textContent=t;o.classList.toggle(â€˜activeâ€™,s)},
setSyncStatus(c){const e=document.getElementById(â€˜syncâ€™);e.className=c?â€˜sync sync-okâ€™:â€˜sync sync-errâ€™;e.textContent=c?â€˜âœ“ Connected to Google Sheetsâ€™:â€˜âš  Offline Modeâ€™},
showModal(o){const{icon=â€˜âš ï¸â€™,title,message,confirmText=â€˜Confirmâ€™,confirmClass=â€™â€™,onConfirm}=o;document.getElementById(â€˜modalIconâ€™).textContent=icon;document.getElementById(â€˜modalTitleâ€™).textContent=title;document.getElementById(â€˜modalMessageâ€™).textContent=message;const b=document.getElementById(â€˜modalConfirmâ€™);b.textContent=confirmText;b.className=â€˜modal-confirm â€˜+confirmClass;b.onclick=()=>{onConfirm();this.closeModal()};document.getElementById(â€˜confirmModalâ€™).classList.add(â€˜activeâ€™)},
closeModal(){document.getElementById(â€˜confirmModalâ€™).classList.remove(â€˜activeâ€™)},
showFieldError(f,s){const e=document.getElementById(f);const m=document.getElementById(f+â€˜Errorâ€™);if(e)e.classList.toggle(â€˜errorâ€™,s);if(m)m.classList.toggle(â€˜showâ€™,s)},
clearFieldErrors(){[â€˜phoneâ€™,â€˜medâ€™,â€˜dateâ€™,â€˜daysâ€™,â€˜branchâ€™].forEach(f=>this.showFieldError(f,false))},
showAlert(m){document.getElementById(â€˜alertTextâ€™).textContent=m;document.getElementById(â€˜alertBannerâ€™).classList.remove(â€˜hiddenâ€™)},
updateOrdersBadge(){const p=State.patients.filter(x=>x.type===â€˜orderâ€™&&x.orderStatus!==â€˜deliveredâ€™).length;const t=document.querySelector(â€™[data-page=â€œpatientsâ€]â€™);let b=t.querySelector(â€™.tab-badgeâ€™);if(p>0){if(!b){b=document.createElement(â€˜spanâ€™);b.className=â€˜tab-badgeâ€™;t.appendChild(b)}b.textContent=p}else if(b)b.remove()}
};
const API={
// âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… POST Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§ØªØµØ§Ù„
async request(a,d=null){
try{
const options = {
method: â€˜POSTâ€™,
body: JSON.stringify({ action: a, data: d })
};
const r=await fetch(CONFIG.API_URL, options);
UI.setSyncStatus(true);
return await r.json()
}catch(e){
console.error(â€˜API Error:â€™,e);
UI.setSyncStatus(false);
throw e
}
},
async loadPatients(){UI.setLoading(true,â€˜Loadingâ€¦â€™);try{const d=await this.request(â€˜getâ€™);State.patients=d.map(p=>({id:String(p.id||â€™â€™),type:p.type||â€˜refillâ€™,name:p.name||â€™â€™,phone:String(p.phone||â€™â€™),med:p.med||â€™â€™,date:Utils.formatDate(p.date),days:String(p.days||â€˜30â€™),notes:p.notes||â€™â€™,addedDate:Utils.formatDate(p.addedDate)||Utils.formatDate(p.date),branch:p.branch||â€™â€™,pickupDate:p.pickupDate||â€™â€™,orderStatus:p.orderStatus||â€˜waitingâ€™,arrivedDate:Utils.formatDate(p.arrivedDate),deliveredDate:Utils.formatDate(p.deliveredDate),reminderSent:p.reminderSent||â€˜noâ€™,reminderDate:Utils.formatDate(p.reminderDate),converted:p.converted||â€˜noâ€™,convertedDate:Utils.formatDate(p.convertedDate),history:Utils.parseHistory(p.history)}));localStorage.setItem(â€˜patients_rass1â€™,JSON.stringify(State.patients));checkTodayAlerts()}catch(e){State.patients=JSON.parse(localStorage.getItem(â€˜patients_rass1â€™))||[];UI.showToast(â€˜Loaded from cacheâ€™,â€˜warningâ€™)}finally{UI.setLoading(false);renderPatients();UI.updateOrdersBadge()}},
async savePatient(p,a){const d={â€¦p,history:JSON.stringify(p.history||[])};try{if(a===â€˜deleteâ€™)await this.request(â€˜deleteâ€™, {id: p.id});else await this.request(a,d);UI.setSyncStatus(true)}catch(e){UI.setSyncStatus(false)}localStorage.setItem(â€˜patients_rass1â€™,JSON.stringify(State.patients))}
};
function setEntryType(t){State.entryType=t;document.getElementById(â€˜entryTypeâ€™).value=t;document.querySelectorAll(â€™.type-btnâ€™).forEach(b=>{b.classList.remove(â€˜activeâ€™);if(b.dataset.type===t)b.classList.add(â€˜activeâ€™)});document.getElementById(â€˜refillFieldsâ€™).style.display=t===â€˜refillâ€™?â€˜blockâ€™:â€˜noneâ€™;document.getElementById(â€˜orderFieldsâ€™).style.display=t===â€˜orderâ€™?â€˜blockâ€™:â€˜noneâ€™;document.getElementById(â€˜submitBtnâ€™).innerHTML=â€™<span>â•</span> Add â€˜+(t===â€˜refillâ€™?â€˜Patientâ€™:â€˜Orderâ€™);UI.clearFieldErrors()}
function handlePickupDateChange(){document.getElementById(â€˜customDateGroupâ€™).style.display=document.getElementById(â€˜pickupDateâ€™).value===â€˜customâ€™?â€˜blockâ€™:â€˜noneâ€™}
const Validation={validateForm(){let v=true;UI.clearFieldErrors();const t=State.entryType,p=document.getElementById(â€˜phoneâ€™).value,m=document.getElementById(â€˜medâ€™).value.trim();if(!Utils.validatePhone(p)){UI.showFieldError(â€˜phoneâ€™,true);v=false}if(!m){UI.showFieldError(â€˜medâ€™,true);v=false}if(t===â€˜refillâ€™){if(!document.getElementById(â€˜dateâ€™).value){UI.showFieldError(â€˜dateâ€™,true);v=false}const d=parseInt(document.getElementById(â€˜daysâ€™).value);if(!d||d<1||d>365){UI.showFieldError(â€˜daysâ€™,true);v=false}}else{if(!document.getElementById(â€˜branchâ€™).value){UI.showFieldError(â€˜branchâ€™,true);v=false}}return v}};
const PatientActions={
async save(e){e.preventDefault();if(!Validation.validateForm()){UI.showToast(â€˜Please fix errorsâ€™,â€˜errorâ€™);return}const btn=document.getElementById(â€˜submitBtnâ€™);btn.disabled=true;btn.innerHTML=â€™<span>â³</span> Savingâ€¦â€™;const t=State.entryType;let pk=â€™â€™;if(t===â€˜orderâ€™){const pv=document.getElementById(â€˜pickupDateâ€™).value;if(pv===â€˜todayâ€™)pk=Utils.getToday();else if(pv===â€˜tomorrowâ€™)pk=Utils.getTomorrow();else if(pv===â€˜customâ€™)pk=document.getElementById(â€˜customPickupDateâ€™).value}const p={id:State.editId||Date.now().toString(),type:t,name:document.getElementById(â€˜nameâ€™).value.trim(),phone:Utils.formatPhone(document.getElementById(â€˜phoneâ€™).value),med:document.getElementById(â€˜medâ€™).value.trim(),date:t===â€˜refillâ€™?document.getElementById(â€˜dateâ€™).value:â€™â€™,days:t===â€˜refillâ€™?document.getElementById(â€˜daysâ€™).value:â€™â€™,notes:document.getElementById(â€˜notesâ€™).value.trim(),addedDate:State.editId?null:Utils.getToday(),branch:t===â€˜orderâ€™?document.getElementById(â€˜branchâ€™).value:â€™â€™,pickupDate:pk,orderStatus:t===â€˜orderâ€™?â€˜waitingâ€™:â€™â€™,arrivedDate:â€™â€™,deliveredDate:â€™â€™,reminderSent:â€˜noâ€™,reminderDate:â€™â€™,converted:â€˜noâ€™,convertedDate:â€™â€™,history:[]};if(State.editId){const x=State.patients.find(i=>i.id===State.editId);p.addedDate=x.addedDate;p.orderStatus=x.orderStatus;p.arrivedDate=x.arrivedDate;p.deliveredDate=x.deliveredDate;p.reminderSent=x.reminderSent;p.reminderDate=x.reminderDate;p.converted=x.converted;p.convertedDate=x.convertedDate;p.history=x.history||[];State.patients[State.patients.findIndex(i=>i.id===State.editId)]=p}else{State.patients.push(p)}await API.savePatient(p,State.editId?â€˜updateâ€™:â€˜addâ€™);UI.showToast(State.editId?â€˜Updated!â€™:â€˜Added!â€™,â€˜successâ€™);renderPatients();UI.updateOrdersBadge();resetForm();btn.disabled=false;btn.innerHTML=â€™<span>â•</span> Add â€˜+(t===â€˜refillâ€™?â€˜Patientâ€™:â€˜Orderâ€™)},
edit(id){const p=State.patients.find(x=>x.id===id);if(!p)return;State.editId=id;setEntryType(p.type||â€˜refillâ€™);document.getElementById(â€˜nameâ€™).value=p.name;document.getElementById(â€˜phoneâ€™).value=p.phone;document.getElementById(â€˜medâ€™).value=p.med;document.getElementById(â€˜notesâ€™).value=p.notes||â€™â€™;if(p.type===â€˜refillâ€™){document.getElementById(â€˜dateâ€™).value=p.date;document.getElementById(â€˜daysâ€™).value=p.days}else{document.getElementById(â€˜branchâ€™).value=p.branch;if(p.pickupDate===Utils.getToday())document.getElementById(â€˜pickupDateâ€™).value=â€˜todayâ€™;else if(p.pickupDate===Utils.getTomorrow())document.getElementById(â€˜pickupDateâ€™).value=â€˜tomorrowâ€™;else if(p.pickupDate){document.getElementById(â€˜pickupDateâ€™).value=â€˜customâ€™;document.getElementById(â€˜customPickupDateâ€™).value=p.pickupDate;document.getElementById(â€˜customDateGroupâ€™).style.display=â€˜blockâ€™}}document.getElementById(â€˜formTitleâ€™).textContent=â€˜âœï¸ Editâ€™;document.getElementById(â€˜submitBtnâ€™).innerHTML=â€™<span>ğŸ’¾</span> Updateâ€™;window.scrollTo({top:0,behavior:â€˜smoothâ€™})},
delete(id){const p=State.patients.find(x=>x.id===id);UI.showModal({icon:â€˜ğŸ—‘ï¸â€™,title:â€˜Deleteâ€™,message:â€˜Delete â€œâ€™+( p.name||â€˜Unnamedâ€™)+â€™â€?â€™,confirmText:â€˜Deleteâ€™,confirmClass:â€˜dangerâ€™,onConfirm:async()=>{State.patients=State.patients.filter(x=>x.id!==id);await API.savePatient({id},â€˜deleteâ€™);UI.showToast(â€˜Deleted!â€™,â€˜successâ€™);renderPatients();UI.updateOrdersBadge()}})},
confirmWhatsApp(id){const p=State.patients.find(x=>x.id===id);UI.showModal({icon:â€˜ğŸ“±â€™,title:â€˜Send WhatsAppâ€™,message:â€˜Send reminder to â€œâ€™+(p.name||â€˜Unnamedâ€™)+â€™â€?â€™,confirmText:â€˜Sendâ€™,confirmClass:â€˜successâ€™,onConfirm:()=>this.sendRefillWhatsApp(id)})},
sendRefillWhatsApp(id){const p=State.patients.find(x=>x.id===id);if(!p)return;const m=â€˜Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ Ø§Ù„Ø±Ø³ 1 ØªØ±Ø­Ø¨ Ø¨ÙƒÙ…\n\nÙ‡Ø°Ø§ ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:\n\nØ§Ù„Ø¯ÙˆØ§Ø¡: â€˜+p.med+â€™\n\nÙ†Ø³Ø¹Ø¯ Ø¨ØªØ¬Ù‡ÙŠØ²Ù‡ Ù„ÙƒÙ… Ø¹Ø¨Ø±:\n\n- Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©\n- Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù…ÙˆÙ‚Ø¹ÙƒÙ…\n\nğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©:\nhttps://shorturl.at/M2Cq3\n\nÙ†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ©â€™;window.open(â€˜https://wa.me/â€™+p.phone+â€™?text=â€™+encodeURIComponent(m),â€™_blankâ€™);p.reminderSent=â€˜yesâ€™;p.reminderDate=Utils.getToday();API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜WhatsApp opened!â€™,â€˜successâ€™);renderPatients();renderTracking()},
confirmArrived(id){const p=State.patients.find(x=>x.id===id);UI.showModal({icon:â€˜ğŸ“¥â€™,title:â€˜Order Arrivedâ€™,message:â€˜Send WhatsApp to â€œâ€™+(p.name||â€˜Unnamedâ€™)+â€™â€?â€™,confirmText:â€˜Yes, Sendâ€™,confirmClass:â€˜successâ€™,onConfirm:()=>this.markArrived(id)})},
async markArrived(id){const p=State.patients.find(x=>x.id===id);p.orderStatus=â€˜pendingâ€™;p.arrivedDate=Utils.getToday();const m=â€˜Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ Ø§Ù„Ø±Ø³ 1\n\nØ·Ù„Ø¨ÙƒÙ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…\n\nØ§Ù„Ø¯ÙˆØ§Ø¡: â€˜+p.med+â€™\n\nğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©:\nhttps://shorturl.at/M2Cq3\n\nÙ†Ø³Ø¹Ø¯ Ø¨Ø®Ø¯Ù…ØªÙƒÙ…â€™;window.open(â€˜https://wa.me/â€™+p.phone+â€™?text=â€™+encodeURIComponent(m),â€™_blankâ€™);await API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜WhatsApp opened!â€™,â€˜successâ€™);renderPatients();UI.updateOrdersBadge()},
async markDelivered(id){const p=State.patients.find(x=>x.id===id);p.orderStatus=â€˜deliveredâ€™;p.deliveredDate=Utils.getToday();await API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜Delivered!â€™,â€˜successâ€™);renderPatients();UI.updateOrdersBadge()},
async markConverted(id){const p=State.patients.find(x=>x.id===id);p.converted=â€˜yesâ€™;p.convertedDate=Utils.getToday();await API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜Converted!â€™,â€˜successâ€™);renderPatients();renderTracking()},
async undoConverted(id){const p=State.patients.find(x=>x.id===id);p.converted=â€˜noâ€™;p.convertedDate=â€™â€™;await API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜Undoneâ€™,â€˜infoâ€™);renderTracking()},
async renewPatient(id){const p=State.patients.find(x=>x.id===id);if(!p.history)p.history=[];p.history.push({date:p.date,reminderDate:p.reminderDate,convertedDate:p.convertedDate});p.date=Utils.getToday();p.reminderSent=â€˜noâ€™;p.reminderDate=â€™â€™;p.converted=â€˜noâ€™;p.convertedDate=â€™â€™;await API.savePatient(p,â€˜updateâ€™);UI.showToast(â€˜Renewed!â€™,â€˜successâ€™);renderPatients();renderTracking()}
};
function checkTodayAlerts(){const t=Utils.getToday();const o=State.patients.filter(p=>p.type===â€˜orderâ€™&&p.orderStatus!==â€˜deliveredâ€™&&p.pickupDate===t).length;const r=State.patients.filter(p=>p.type===â€˜refillâ€™&&Utils.getDaysUntilRefill(p)<0).length;let m=[];if(o>0)m.push(o+â€™ orders for todayâ€™);if(r>0)m.push(r+â€™ overdue refillsâ€™);if(m.length>0)UI.showAlert(â€˜ğŸ”” â€˜+m.join(â€™ â€¢ â€˜))}
function renderPatients(){const s=State.searchQuery.toLowerCase(),tf=State.typeFilter,sf=State.statusFilter;let f=State.patients.filter(p=>{const ms=p.name.toLowerCase().includes(s)||p.med.toLowerCase().includes(s)||p.phone.includes(s);if(!ms)return false;if(tf!==â€˜allâ€™&&p.type!==tf)return false;if(sf!==â€˜allâ€™){if(p.type===â€˜refillâ€™){const d=Utils.getDaysUntilRefill(p);if(sf===â€˜overdueâ€™&&d>=0)return false;if(sf===â€˜soonâ€™&&(d<0||d>2))return false;if(sf===â€˜okâ€™&&d<=2)return false;if(sf===â€˜waitingâ€™||sf===â€˜pendingâ€™)return false}else{if(sf===â€˜waitingâ€™&&p.orderStatus!==â€˜waitingâ€™)return false;if(sf===â€˜pendingâ€™&&p.orderStatus!==â€˜pendingâ€™)return false;if([â€˜overdueâ€™,â€˜soonâ€™,â€˜okâ€™].includes(sf))return false}}return true});f.sort((a,b)=>{if(a.type===â€˜orderâ€™&&b.type===â€˜refillâ€™)return -1;if(a.type===â€˜refillâ€™&&b.type===â€˜orderâ€™)return 1;if(a.type===â€˜orderâ€™)return new Date(a.addedDate)-new Date(b.addedDate);return Utils.getRefillDate(a)-Utils.getRefillDate(b)});let w=0,o=0,po=0;State.patients.forEach(p=>{if(p.type===â€˜refillâ€™){const d=Utils.getDaysUntilRefill(p);if(d<0)o++;else if(d<=2)w++}else if(p.type===â€˜orderâ€™&&p.orderStatus!==â€˜deliveredâ€™)po++});document.getElementById(â€˜totalâ€™).textContent=State.patients.length;document.getElementById(â€˜warnâ€™).textContent=w;document.getElementById(â€˜overâ€™).textContent=o;document.getElementById(â€˜pendingOrdersâ€™).textContent=po;const tp=Math.ceil(f.length/CONFIG.ITEMS_PER_PAGE);State.currentPage=Math.min(State.currentPage,tp||1);const si=(State.currentPage-1)*CONFIG.ITEMS_PER_PAGE;const pg=f.slice(si,si+CONFIG.ITEMS_PER_PAGE);const tb=document.getElementById(â€˜patientsTbodyâ€™);if(pg.length===0){tb.innerHTML=â€™<tr><td colspan="7"><div class="empty">No records found</div></td></tr>â€™;document.getElementById(â€˜paginationâ€™).innerHTML=â€™â€™;return}tb.innerHTML=pg.map(p=>{const io=p.type===â€˜orderâ€™;let st,sc,dd;if(io){if(p.orderStatus===â€˜deliveredâ€™){st=â€˜âœ… Deliveredâ€™;sc=â€˜deliveredâ€™}else if(p.orderStatus===â€˜pendingâ€™){st=â€˜â³ Pendingâ€™;sc=â€˜waitingâ€™}else{st=â€˜ğŸ”µ Waitingâ€™;sc=â€˜infoâ€™}dd=p.pickupDate?Utils.formatDisplayDate(p.pickupDate):â€™-â€™}else{const d=Utils.getDaysUntilRefill(p);dd=Utils.getRefillDate(p).toLocaleDateString(â€˜en-USâ€™,{month:â€˜shortâ€™,day:â€˜numericâ€™});if(d<0){st=â€˜Overdue â€˜+Math.abs(d)+â€˜dâ€™;sc=â€˜dangerâ€™}else if(d<=2){st=d+â€˜d leftâ€™;sc=â€˜warnâ€™}else{st=d+â€˜d leftâ€™;sc=â€˜okâ€™}}const ad=Utils.formatDisplayDate(p.addedDate);const hc=(p.history||[]).length;const hb=hc>0?â€™ <span class="badge badge-ok">â€™+hc+â€™</span>â€™:â€™â€™;let ac=â€™â€™;if(io){if(p.orderStatus===â€˜waitingâ€™)ac=â€™<button class="arrived" onclick="PatientActions.confirmArrived(\''+p.id+'\')" title="Arrived">ğŸ“¥</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">âœï¸</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">ğŸ—‘ï¸</button>â€™;else if(p.orderStatus===â€˜pendingâ€™)ac=â€™<button class="done" onclick="PatientActions.markDelivered(\''+p.id+'\')" title="Delivered">âœ…</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">âœï¸</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">ğŸ—‘ï¸</button>â€™;else ac=â€™<button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">âœï¸</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">ğŸ—‘ï¸</button>â€™}else{ac=â€™<button class="wa" onclick="PatientActions.confirmWhatsApp(\''+p.id+'\')" title="WhatsApp">ğŸ“±</button><button class="edit" onclick="PatientActions.edit(\''+p.id+'\')" title="Edit">âœï¸</button><button class="del" onclick="PatientActions.delete(\''+p.id+'\')" title="Delete">ğŸ—‘ï¸</button>â€™}return â€˜<tr class="'+(io?'order-row':'')+'"><td><span class="type-badge">â€™+(io?â€˜ğŸ“¦â€™:â€˜ğŸ’Šâ€™)+â€™</span></td><td><div class="name">â€™+(Utils.sanitize(p.name)||â€˜Unnamedâ€™)+hb+â€™</div><div class="phone"><span class="phone-copy" onclick="Utils.copyToClipboard(\''+p.phone+'\')" title="Copy">ğŸ“‹</span>â€™+Utils.sanitize(p.phone)+â€™</div>â€™+(io&&p.branch?â€™<div class="branch">From: â€˜+p.branch+â€™</div>â€™:â€™â€™)+â€™</td><td><div class="med">â€™+Utils.sanitize(p.med)+â€™</div>â€™+(p.notes?â€™<div class="phone">â€™+Utils.sanitize(p.notes)+â€™</div>â€™:â€™â€™)+â€™</td><td><span class="date-added">â€™+ad+â€™</span></td><td>â€™+dd+â€™</td><td><span class="badge badge-'+sc+'">â€™+st+â€™</span></td><td><div class="actions">â€™+ac+â€™</div></td></tr>â€™}).join(â€™â€™);renderPagination(tp,f.length)}
function renderPagination(tp,ti){const pg=document.getElementById(â€˜paginationâ€™);if(tp<=1){pg.innerHTML=â€™â€™;return}let h=â€™<button onclick=â€œchangePage(1)â€ â€˜+(State.currentPage===1?â€˜disabledâ€™:â€™â€™)+â€™>Â«</button><button onclick=â€œchangePage(â€™+(State.currentPage-1)+â€™)â€ â€˜+(State.currentPage===1?â€˜disabledâ€™:â€™â€™)+â€™>â€¹</button>â€™;const mv=5;let st=Math.max(1,State.currentPage-Math.floor(mv/2));let en=Math.min(tp,st+mv-1);if(en-st+1<mv)st=Math.max(1,en-mv+1);for(let i=st;i<=en;i++)h+=â€™<button onclick="changePage('+i+')" class="'+(i===State.currentPage?'active':'')+'">â€™+i+â€™</button>â€™;h+=â€™<button onclick=â€œchangePage(â€™+(State.currentPage+1)+â€™)â€ â€˜+(State.currentPage===tp?â€˜disabledâ€™:â€™â€™)+â€™>â€º</button><button onclick=â€œchangePage(â€™+tp+â€™)â€ â€˜+(State.currentPage===tp?â€˜disabledâ€™:â€™â€™)+â€™>Â»</button><span class="pagination-info">â€™+ti+â€™ records</span>â€™;pg.innerHTML=h}
function changePage(p){State.currentPage=p;renderPatients()}
function renderTracking(){const fl=document.getElementById(â€˜trackFilterâ€™).value;let l=State.patients.filter(p=>p.type===â€˜refillâ€™&&p.reminderSent===â€˜yesâ€™);if(fl===â€˜waitingâ€™)l=l.filter(p=>p.converted!==â€˜yesâ€™);else if(fl===â€˜convertedâ€™)l=l.filter(p=>p.converted===â€˜yesâ€™);l.sort((a,b)=>new Date(b.reminderDate)-new Date(a.reminderDate));let ts=0,tc=0;State.patients.filter(p=>p.type===â€˜refillâ€™).forEach(p=>{if(p.reminderSent===â€˜yesâ€™)ts++;if(p.converted===â€˜yesâ€™)tc++;(p.history||[]).forEach(h=>{if(h.reminderDate)ts++;if(h.convertedDate)tc++})});document.getElementById(â€˜tSentâ€™).textContent=ts;document.getElementById(â€˜tConvertedâ€™).textContent=tc;document.getElementById(â€˜tRateâ€™).textContent=ts>0?Math.round(tc/ts*100)+â€™%â€™:â€˜0%â€™;const g=document.getElementById(â€˜trackGridâ€™);if(l.length===0){g.innerHTML=â€™<div class="empty" style="grid-column:1/-1">No records</div>â€™;return}g.innerHTML=l.map(p=>{const hc=(p.history||[]).length;const hb=hc>0?â€™<div class="history-badge">ğŸ”„ â€˜+hc+â€™</div>â€™:â€™â€™;if(p.converted===â€˜yesâ€™){return â€˜<div class="track-card converted">â€™+hb+â€™<div class="name">â€™+(Utils.sanitize(p.name)||â€˜Unnamedâ€™)+â€™</div><div class="phone">â€™+Utils.sanitize(p.phone)+â€™</div><div class="med">â€™+Utils.sanitize(p.med)+â€™</div><div class="info">ğŸ“¤ â€˜+p.reminderDate+â€™<br>âœ… â€˜+p.convertedDate+â€™</div><button class="track-btn done" onclick="PatientActions.undoConverted(\''+p.id+'\')">âœ… Converted (Undo)</button><button class="track-btn renew" onclick="PatientActions.renewPatient(\''+p.id+'\')">ğŸ”„ Renew</button></div>â€™}else{return â€˜<div class="track-card">â€™+hb+â€™<div class="name">â€™+(Utils.sanitize(p.name)||â€˜Unnamedâ€™)+â€™</div><div class="phone">â€™+Utils.sanitize(p.phone)+â€™</div><div class="med">â€™+Utils.sanitize(p.med)+â€™</div><div class="info">ğŸ“¤ â€˜+p.reminderDate+â€™</div><button class="track-btn" onclick="PatientActions.markConverted(\''+p.id+'\')">âœ… Mark Converted</button></div>â€™}}).join(â€™â€™)}
function showReportTab(t){document.querySelectorAll(â€™.report-tabâ€™).forEach(x=>x.classList.remove(â€˜activeâ€™));document.querySelectorAll(â€™.report-sectionâ€™).forEach(x=>x.classList.remove(â€˜activeâ€™));document.querySelector(â€™[data-report=â€â€™+t+â€™â€]â€™).classList.add(â€˜activeâ€™);document.getElementById(t===â€˜refillâ€™?â€˜refillReportâ€™:â€˜ordersReportâ€™).classList.add(â€˜activeâ€™)}
function generateReport(){const m=parseInt(document.getElementById(â€˜reportMonthâ€™).value);const y=parseInt(document.getElementById(â€˜reportYearâ€™).value);generateRefillReport(m,y);generateOrdersReport(m,y)}
function generateRefillReport(m,y){let s=0,c=0;const cp=[];State.patients.filter(p=>p.type===â€˜refillâ€™).forEach(p=>{if(p.reminderSent===â€˜yesâ€™&&p.reminderDate){const rd=new Date(p.reminderDate);if(rd.getMonth()===m&&rd.getFullYear()===y){s++;if(p.converted===â€˜yesâ€™){c++;cp.push({name:p.name,phone:p.phone,med:p.med,reminderDate:p.reminderDate,convertedDate:p.convertedDate})}}}(p.history||[]).forEach(h=>{if(h.reminderDate){const rd=new Date(h.reminderDate);if(rd.getMonth()===m&&rd.getFullYear()===y){s++;if(h.convertedDate){c++;cp.push({name:p.name,phone:p.phone,med:p.med,reminderDate:h.reminderDate,convertedDate:h.convertedDate})}}}})});const r=s>0?Math.round(c/s*100):0;const w=s-c;const wr=s>0?Math.round(w/s*100):0;document.getElementById(â€˜rSentâ€™).textContent=s;document.getElementById(â€˜rConvertedâ€™).textContent=c;document.getElementById(â€˜rRateâ€™).textContent=r+â€™%â€™;document.getElementById(â€˜rBarâ€™).style.width=r+â€™%â€™;document.getElementById(â€˜summaryTbâ€™).innerHTML=â€™<tr><td>ğŸ“¤ Sent</td><td>â€™+s+â€™</td><td>100%</td></tr><tr><td>âœ… Converted</td><td>â€™+c+â€™</td><td>â€™+r+â€™%</td></tr><tr><td>â³ Waiting</td><td>â€™+w+â€™</td><td>â€™+wr+â€™%</td></tr>â€™;document.getElementById(â€˜convListâ€™).innerHTML=cp.length>0?cp.map(p=>â€™<tr><td class="name">â€™+(Utils.sanitize(p.name)||â€˜Unnamedâ€™)+â€™</td><td class="phone">â€™+Utils.sanitize(p.phone)+â€™</td><td class="med">â€™+Utils.sanitize(p.med)+â€™</td><td>â€™+p.reminderDate+â€™</td><td>â€™+p.convertedDate+â€™</td></tr>â€™).join(â€™â€™):â€™<tr><td colspan="5"><div class="empty">No conversions</div></td></tr>â€™}
function generateOrdersReport(m,y){let t=0,d=0;const bs={},mc={};State.patients.filter(p=>p.type===â€˜orderâ€™).forEach(p=>{const ad=new Date(p.addedDate);if(ad.getMonth()===m&&ad.getFullYear()===y){t++;if(!bs[p.branch])bs[p.branch]={total:0,delivered:0};bs[p.branch].total++;const mn=p.med.toLowerCase().trim();mc[mn]=(mc[mn]||0)+1;if(p.orderStatus===â€˜deliveredâ€™){d++;bs[p.branch].delivered++}}});const nd=t-d;const r=t>0?Math.round(d/t*100):0;document.getElementById(â€˜oTotalâ€™).textContent=t;document.getElementById(â€˜oDeliveredâ€™).textContent=d;document.getElementById(â€˜oNotDeliveredâ€™).textContent=nd;document.getElementById(â€˜oRateâ€™).textContent=r+â€™%â€™;document.getElementById(â€˜oBarâ€™).style.width=r+â€™%â€™;const br=Object.entries(bs).sort((a,b)=>b[1].total-a[1].total).map(([b,s])=>â€™<tr><td><strong>â€™+b+â€™</strong></td><td>â€™+s.total+â€™</td><td>â€™+s.delivered+â€™</td><td>â€™+(s.total-s.delivered)+â€™</td></tr>â€™).join(â€™â€™);document.getElementById(â€˜branchSummaryâ€™).innerHTML=br||â€™<tr><td colspan="4"><div class="empty">No orders</div></td></tr>â€™;const tm=Object.entries(mc).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([med,cnt])=>â€™<tr><td class="med">â€™+Utils.sanitize(med)+â€™</td><td>â€™+cnt+â€™</td></tr>â€™).join(â€™â€™);document.getElementById(â€˜topMedsâ€™).innerHTML=tm||â€™<tr><td colspan="2"><div class="empty">No orders</div></td></tr>â€™}
function resetForm(){State.editId=null;document.getElementById(â€˜patientFormâ€™).reset();document.getElementById(â€˜daysâ€™).value=â€˜30â€™;document.getElementById(â€˜dateâ€™).valueAsDate=new Date();document.getElementById(â€˜formTitleâ€™).textContent=â€˜â• Add Newâ€™;document.getElementById(â€˜submitBtnâ€™).innerHTML=â€™<span>â•</span> Add â€˜+(State.entryType===â€˜refillâ€™?â€˜Patientâ€™:â€˜Orderâ€™);document.getElementById(â€˜customDateGroupâ€™).style.display=â€˜noneâ€™;UI.clearFieldErrors()}
function showPage(n){document.querySelectorAll(â€™.pageâ€™).forEach(p=>p.classList.remove(â€˜activeâ€™));document.querySelectorAll(â€™.tabâ€™).forEach(t=>t.classList.remove(â€˜activeâ€™));document.getElementById(n+â€˜Pageâ€™).classList.add(â€˜activeâ€™);document.querySelector(â€™[data-page=â€â€™+n+â€™â€]â€™).classList.add(â€˜activeâ€™);if(n===â€˜trackingâ€™)renderTracking();if(n===â€˜reportsâ€™)generateReport()}
window.PatientActions=PatientActions;window.Utils=Utils;window.UI=UI;window.changePage=changePage;window.resetForm=resetForm;window.setEntryType=setEntryType;window.showReportTab=showReportTab;
document.addEventListener(â€˜DOMContentLoadedâ€™,()=>{document.getElementById(â€˜dateâ€™).valueAsDate=new Date();const ms=document.getElementById(â€˜reportMonthâ€™);const ys=document.getElementById(â€˜reportYearâ€™);const cd=new Date();CONFIG.MONTHS.forEach((m,i)=>{ms.innerHTML+=â€™<option value="'+i+'">â€™+m+â€™</option>â€™});ms.value=cd.getMonth();for(let y=cd.getFullYear();y<=cd.getFullYear()+3;y++){ys.innerHTML+=â€™<option value="'+y+'">â€™+y+â€™</option>â€™}ys.value=cd.getFullYear();document.querySelectorAll(â€™.tabâ€™).forEach(t=>{t.addEventListener(â€˜clickâ€™,()=>showPage(t.dataset.page))});document.getElementById(â€˜patientFormâ€™).addEventListener(â€˜submitâ€™,PatientActions.save);document.getElementById(â€˜pickupDateâ€™).addEventListener(â€˜changeâ€™,handlePickupDateChange);document.getElementById(â€˜searchâ€™).addEventListener(â€˜inputâ€™,Utils.debounce(e=>{State.searchQuery=e.target.value;State.currentPage=1;renderPatients()},CONFIG.SEARCH_DELAY));document.getElementById(â€˜typeFilterâ€™).addEventListener(â€˜changeâ€™,e=>{State.typeFilter=e.target.value;State.currentPage=1;renderPatients()});document.getElementById(â€˜statusFilterâ€™).addEventListener(â€˜changeâ€™,e=>{State.statusFilter=e.target.value;State.currentPage=1;renderPatients()});document.getElementById(â€˜trackFilterâ€™).addEventListener(â€˜changeâ€™,renderTracking);document.getElementById(â€˜reportMonthâ€™).addEventListener(â€˜changeâ€™,generateReport);document.getElementById(â€˜reportYearâ€™).addEventListener(â€˜changeâ€™,generateReport);API.loadPatients()});
</script>

</body>
</html>
