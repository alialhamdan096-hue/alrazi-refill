<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rass 1 Refill Cash Patients System</title>
    <style>
        :root{--primary:#561C2C;--primary-light:#7a2840;--accent:#8DC63F;--accent-dark:#6fa329;--text-dark:#333;--gray:#666;--gray-light:#f5f5f5;--white:#fff;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--order-bg:#eff6ff;--shadow-sm:0 2px 4px rgba(0,0,0,0.05);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 25px rgba(0,0,0,0.1);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-full:9999px;--transition:0.3s ease}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(180deg,#f9f6f2 0%,#e8dccf 100%);color:var(--text-dark);min-height:100vh;padding:20px;line-height:1.6}
        
        /* UI Components */
        .toast-container{position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px}
        .toast{padding:14px 20px;border-radius:var(--radius-md);color:white;font-weight:500;box-shadow:var(--shadow-lg);animation:slideIn .3s ease;display:flex;align-items:center;gap:10px;min-width:280px}
        .toast.hiding{animation:slideOut .3s ease forwards}
        .toast-success{background:var(--success)}.toast-error{background:var(--danger)}.toast-warning{background:var(--warning)}.toast-info{background:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
        
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;z-index:9999;opacity:0;visibility:hidden;transition:var(--transition)}
        .loading-overlay.active{opacity:1;visibility:visible}
        .spinner{width:50px;height:50px;border:4px solid var(--gray-light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{color:var(--primary);font-weight:600}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Layout */
        .container{max-width:1200px;margin:0 auto}
        .header-container{text-align:center;margin-bottom:25px}
        .logo-img{height:90px;margin-bottom:15px;filter:drop-shadow(0 2px 4px rgba(86,28,44,0.2))}
        h1{color:var(--primary);margin-bottom:10px;font-weight:700}
        
        /* Navigation */
        .tabs{display:flex;justify-content:center;gap:10px;margin-bottom:25px;flex-wrap:wrap}
        .tab{background:rgba(255,255,255,0.7);border:none;padding:12px 30px;border-radius:var(--radius-full);cursor:pointer;font-weight:bold;color:var(--gray);transition:var(--transition);box-shadow:var(--shadow-sm);position:relative}
        .tab.active{background:var(--primary);color:white;box-shadow:0 4px 10px rgba(86,28,44,0.3)}
        .tab:hover:not(.active){background:white;transform:translateY(-2px)}
        
        .page{display:none;animation:fadeIn .3s ease}.page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
        
        /* Grid & Cards */
        .grid{display:grid;grid-template-columns:350px 1fr;gap:20px}
        @media(max-width:900px){.grid{grid-template-columns:1fr}}
        .card{background:var(--white);border-radius:var(--radius-lg);padding:25px;margin-bottom:20px;box-shadow:var(--shadow-lg)}
        .card-title{color:var(--primary);margin-bottom:20px;font-size:18px;font-weight:600}
        
        /* Form Elements */
        .type-selector{display:flex;gap:10px;margin-bottom:20px}
        .type-btn{flex:1;padding:15px;border:2px solid #e5e5e5;border-radius:var(--radius-md);background:white;cursor:pointer;transition:var(--transition);text-align:center}
        .type-btn:hover{border-color:var(--primary)}
        .type-btn.active{border-color:var(--primary);background:rgba(86,28,44,0.05)}
        .type-btn.active.order{border-color:var(--info);background:var(--order-bg)}
        .type-btn-icon{font-size:24px;margin-bottom:5px}.type-btn-label{font-weight:600;color:var(--text-dark)}.type-btn-desc{font-size:12px;color:var(--gray)}
        
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;color:#555;font-size:14px;font-weight:600}
        label .required{color:var(--danger)}
        input,select{width:100%;padding:12px;background:#fafafa;border:2px solid #e5e5e5;border-radius:var(--radius-sm);color:#333;font-size:14px;transition:var(--transition)}
        input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(86,28,44,0.1);background:white}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        
        .btn{padding:12px 20px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:bold;width:100%;margin-top:10px;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:var(--primary);color:white}.btn-primary:hover:not(:disabled){background:var(--primary-light);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .btn-secondary{background:#6c757d;color:white}.btn-secondary:hover:not(:disabled){background:#5a6268}
        
        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px}
        .stat{background:white;padding:20px;border-radius:var(--radius-md);box-shadow:var(--shadow-md);position:relative;overflow:hidden}
        .stat::after{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--gray)}
        .stat-num{font-size:28px;font-weight:800;color:var(--text-dark)}.stat-label{color:#888;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;margin-top:5px}
        .stat.total::after{background:var(--primary)}.stat.w::after{background:#f59e0b}.stat.d::after{background:#ef4444}.stat.orders::after{background:var(--info)}
        
        /* Table */
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px}
        th{text-align:left;padding:15px;background:#f9f9f9;color:var(--gray);font-size:12px;text-transform:uppercase;border-bottom:2px solid #eee;white-space:nowrap}
        td{padding:15px;border-bottom:1px solid #eee;vertical-align:middle}
        tr:hover{background:#fcfcfc}
        tr.order-row{background:var(--order-bg)}tr.order-row:hover{background:#e0edff}
        .name{font-weight:bold;color:var(--primary)}
        .phone{color:#888;font-size:13px;margin-top:2px;display:flex;align-items:center;gap:5px}
        .badge{padding:6px 14px;border-radius:var(--radius-full);font-size:11px;font-weight:bold;letter-spacing:0.5px;white-space:nowrap}
        .badge-ok{background:rgba(141,198,63,0.15);color:var(--accent-dark)}
        .badge-warn{background:rgba(245,158,11,0.15);color:#d97706}
        .badge-danger{background:rgba(239,68,68,0.15);color:#dc2626}
        .badge-info{background:rgba(59,130,246,0.15);color:var(--info)}
        
        .actions{display:flex;gap:6px;flex-wrap:wrap}
        .actions button{width:34px;height:34px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:var(--transition);display:flex;align-items:center;justify-content:center}
        .wa{background:#25D366;color:white}.edit{background:rgba(86,28,44,0.1);color:var(--primary)}.del{background:rgba(239,68,68,0.1);color:#ef4444}
        
        /* Tracking & Reports */
        .track-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px}
        .track-card{background:white;border:2px solid #eee;border-radius:var(--radius-md);padding:20px;transition:var(--transition);box-shadow:var(--shadow-sm)}
        .track-card.converted{border-color:var(--accent);background:rgba(141,198,63,0.05)}
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:25px}
        .report-card{background:var(--white);border-radius:var(--radius-md);padding:25px;text-align:center;box-shadow:var(--shadow-lg)}
        .report-value{font-size:42px;font-weight:bold;color:var(--primary)}
        
        @media(max-width:600px){.grid{grid-template-columns:1fr}.stats{grid-template-columns:1fr 1fr}.type-selector{flex-direction:column}.row{grid-template-columns:1fr!important}}
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</div></div>

    <div class="container">
        <div class="header-container">
            <h1>Rass 1 Refill Cash Patients System</h1>
            <p style="color:#666">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ - ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-page="patients">ğŸ“‹ Ø§Ù„Ù…Ø±Ø¶Ù‰ (Patients)</button>
            <button class="tab" data-page="tracking">ğŸ“Š Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Tracking)</button>
            <button class="tab" data-page="reports">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Reports)</button>
        </div>
        
        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="total">0</div><div class="stat-label">Ø§Ù„ÙƒÙ„</div></div>
                <div class="stat w"><div class="stat-num" id="warn">0</div><div class="stat-label">Ù‚Ø±ÙŠØ¨</div></div>
                <div class="stat d"><div class="stat-num" id="over">0</div><div class="stat-label">Ù…ØªØ£Ø®Ø±</div></div>
                <div class="stat orders"><div class="stat-num" id="pendingOrders">0</div><div class="stat-label">Ø·Ù„Ø¨ÙŠØ§Øª</div></div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h3 class="card-title" id="formTitle">â• Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="type-selector">
                        <button type="button" class="type-btn active refill" onclick="setEntryType('refill')">
                            <div class="type-btn-icon">ğŸ’Š</div>
                            <div class="type-btn-label">Refill</div>
                            <div class="type-btn-desc">Ù…Ø±ÙŠØ¶ Ù…ØªØ§Ø¨Ø¹Ø©</div>
                        </button>
                        <button type="button" class="type-btn order" onclick="setEntryType('order')">
                            <div class="type-btn-icon">ğŸ“¦</div>
                            <div class="type-btn-label">Order</div>
                            <div class="type-btn-desc">Ø·Ù„Ø¨ Ù…Ù† ÙØ±Ø¹</div>
                        </button>
                    </div>
                    
                    <form id="patientForm" onsubmit="PatientActions.save(event)">
                        <input type="hidden" id="entryType" value="refill">
                        <input type="hidden" id="editId">
                        
                        <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ <span class="required">*</span></label><input type="tel" id="phone" placeholder="05xxxxxxxx" required></div>
                        <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label><input type="text" id="name" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
                        <div class="form-group"><label>Ø§Ù„Ø¯ÙˆØ§Ø¡ <span class="required">*</span></label><input type="text" id="med" required></div>
                        
                        <div id="refillFields">
                            <div class="row">
                                <div class="form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù</label><input type="date" id="date"></div>
                                <div class="form-group"><label>Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label><input type="number" id="days" value="30"></div>
                            </div>
                        </div>
                        
                        <div id="orderFields" style="display:none">
                            <div class="form-group"><label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…ØµØ¯Ø±</label>
                                <input type="text" id="branch" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù†ÙŠØ²Ø© 1">
                            </div>
                        </div>
                        
                        <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="notes"></div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn"><span>â•</span> Ø­ÙØ¸</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>
                    <input type="text" id="search" placeholder="ğŸ” Ø¨Ø­Ø«..." style="margin-bottom:15px">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="trackingPage" class="page">
            <div class="stats">
                <div class="stat total"><div class="stat-num" id="tSent">0</div><div class="stat-label">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div></div>
                <div class="stat s"><div class="stat-num" id="tConverted">0</div><div class="stat-label">ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</div></div>
                <div class="stat"><div class="stat-num" id="tRate">0%</div><div class="stat-label">Ø§Ù„Ù†Ø³Ø¨Ø©</div></div>
            </div>
            <div class="card">
                <h3 class="card-title">ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</h3>
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <div id="reportsPage" class="page">
            <div class="report-grid">
                <div class="report-card"><div class="report-value" id="rSent">0</div><div class="report-label">ğŸ“¤ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--accent)" id="rConverted">0</div><div class="report-label">âœ… Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø¶Ø±ÙˆØ§</div></div>
                <div class="report-card"><div class="report-value" style="color:var(--primary)" id="rRate">0%</div><div class="report-label">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div></div>
            </div>
        </div>
    </div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
const API_URL = 'https://script.google.com/macros/s/AKfycbykcl1v2TEURnPasMiMbJFCmnC6MgGfhHCAGmwOM6vu_sxpt7CdFM6NcDCRDxrGPVlo/exec';
let patients = [];
const WA_ICON = `<svg viewBox="0 0 32 32" width="18" height="18" fill="white"><path d="M16,2A13,13,0,0,0,4.9,22.2L2,30l7.8-2.9A13,13,0,1,0,16,2z M22.7,21.7c-0.3,0.8-1.5,1.5-2.1,1.5c-0.6,0-2.3-0.7-5.4-3.6c-2.4-2.3-3.8-4.5-4.1-5.1s0-1,0.6-1.6c0.3-0.3,0.5-0.5,0.7-0.8c0.2-0.2,0.1-0.5,0-0.7s-1.2-3-1.6-4.1c-0.4-1.1-0.9-0.9-1.2-0.9H9.1c-0.4,0-1,0.2-1.6,0.8c-0.6,0.6-2.2,2.2-2.2,5.3s2.3,6.1,2.6,6.5c0.3,0.4,4.4,6.7,10.7,9.4c3.7,1.6,5.2,1.6,6.1,1.5c1-0.1,2.7-1.1,3.1-2.2C28.1,22.9,28.1,22.1,27.8,22C27.5,21.9,26,21.1,25.4,20.8C24.8,20.5,24.4,20.3,24.2,20.6C24,21,23.3,21.9,22.7,21.7z"/></svg>`;

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date').valueAsDate = new Date();
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => showPage(t.dataset.page)));
    document.getElementById('search').addEventListener('input', renderPatients);
    loadPatients();
});

// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadPatients() {
    UI.setLoading(true);
    try {
        const local = localStorage.getItem('rass1_data');
        if(local) { patients = JSON.parse(local); renderPatients(); }
        
        const res = await fetch(API_URL + '?action=get'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… GET Ù„Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨
        const data = await res.json();
        if(Array.isArray(data)) {
            patients = data;
            localStorage.setItem('rass1_data', JSON.stringify(patients));
            renderPatients();
            updateStats();
        }
    } catch(e) { console.error(e); }
    UI.setLoading(false);
}

const PatientActions = {
    async save(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const type = document.getElementById('entryType').value;
        
        const p = {
            id: id || Date.now().toString(),
            type: type,
            phone: document.getElementById('phone').value,
            name: document.getElementById('name').value,
            med: document.getElementById('med').value,
            date: document.getElementById('date').value,
            days: document.getElementById('days').value,
            branch: document.getElementById('branch').value,
            notes: document.getElementById('notes').value,
            reminderSent: 'no', converted: 'no'
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        if(id) {
            const idx = patients.findIndex(x => x.id == id);
            if(idx > -1) {
                p.reminderSent = patients[idx].reminderSent;
                p.converted = patients[idx].converted;
                patients[idx] = p;
            }
        } else {
            patients.push(p);
        }
        
        renderPatients();
        resetForm();
        UI.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: id ? 'update' : 'add', data: p })
        });
    },

    delete(id) {
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
        patients = patients.filter(x => x.id != id);
        renderPatients();
        localStorage.setItem('rass1_data', JSON.stringify(patients));
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', data: {id} }) });
    },

    whatsapp(id) {
        const p = patients.find(x => x.id == id);
        let phone = p.phone.replace(/\D/g,'');
        if(!phone.startsWith('966')) phone = '966' + phone.replace(/^0/,'');
        
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ ØªØ°ÙƒØ±ÙƒÙ… Ø¨Ù…ÙˆØ¹Ø¯ ØµØ±Ù Ø§Ù„Ø¹Ù„Ø§Ø¬: ${p.med}\n\nØ§Ù„Ù…ÙˆÙ‚Ø¹:\nhttps://shorturl.at/M2Cq3`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`);
        
        p.reminderSent = 'yes';
        p.reminderDate = new Date().toISOString().split('T')[0];
        localStorage.setItem('rass1_data', JSON.stringify(patients));
        renderPatients();
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', data: p }) });
    },
    
    markConverted(id) {
        const p = patients.find(x => x.id == id);
        p.converted = 'yes';
        renderPatients();
        renderTracking();
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', data: p }) });
    },

    edit(id) {
        const p = patients.find(x => x.id == id);
        document.getElementById('editId').value = p.id;
        document.getElementById('phone').value = p.phone;
        document.getElementById('name').value = p.name;
        document.getElementById('med').value = p.med;
        document.getElementById('notes').value = p.notes;
        setEntryType(p.type || 'refill');
        if(p.type === 'refill') {
            document.getElementById('date').value = p.date;
            document.getElementById('days').value = p.days;
        } else {
            document.getElementById('branch').value = p.branch;
        }
        document.getElementById('submitBtn').innerHTML = '<span>ğŸ’¾</span> ØªØ¹Ø¯ÙŠÙ„';
        document.getElementById('formTitle').innerText = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª';
    }
};

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶
function renderPatients() {
    const q = document.getElementById('search').value.toLowerCase();
    const tbody = document.getElementById('patientsTbody');
    const today = new Date();
    let stats = {total:0, warn:0, over:0, orders:0};

    const html = patients.filter(p => (p.name+p.phone+p.med).toLowerCase().includes(q))
    .sort((a,b) => new Date(a.date||'2099') - new Date(b.date||'2099'))
    .map(p => {
        stats.total++;
        let status = '', badgeClass = '';
        
        if(p.type === 'refill') {
            const nextDate = new Date(new Date(p.date).getTime() + (parseInt(p.days||30) * 86400000));
            const diff = Math.ceil((nextDate - today) / 86400000);
            
            if(diff < 0) { status = `Ù…ØªØ£Ø®Ø± ${Math.abs(diff)} ÙŠÙˆÙ…`; badgeClass = 'badge-danger'; stats.over++; }
            else if(diff <= 2) { status = `Ø¨Ø§Ù‚ÙŠ ${diff} ÙŠÙˆÙ…`; badgeClass = 'badge-warn'; stats.warn++; }
            else { status = `Ø¨Ø§Ù‚ÙŠ ${diff} ÙŠÙˆÙ…`; badgeClass = 'badge-ok'; }
        } else {
            status = 'Ø·Ù„Ø¨ Ø®Ø§Øµ'; badgeClass = 'badge-info'; stats.orders++;
        }

        return `<tr class="${p.type === 'order' ? 'order-row' : ''}">
            <td><span class="badge ${p.type === 'order' ? 'badge-info' : 'badge-ok'}">${p.type === 'order' ? 'ğŸ“¦' : 'ğŸ’Š'}</span></td>
            <td><div class="name">${p.name||'Guest'}</div><div class="phone">${p.phone}</div></td>
            <td><div class="med">${p.med}</div><div class="phone">${p.notes||''}</div></td>
            <td><span class="badge ${badgeClass}">${status}</span></td>
            <td>
                <div class="actions">
                    <button class="wa" onclick="PatientActions.whatsapp('${p.id}')">${WA_ICON}</button>
                    <button class="edit" onclick="PatientActions.edit('${p.id}')">âœï¸</button>
                    <button class="del" onclick="PatientActions.delete('${p.id}')">ğŸ—‘ï¸</button>
                </div>
            </td>
        </tr>`;
    }).join('');

    tbody.innerHTML = html || '<tr><td colspan="5" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
    updateStats(stats);
    renderTracking();
}

function renderTracking() {
    const grid = document.getElementById('trackGrid');
    const tracked = patients.filter(p => p.reminderSent === 'yes');
    const converted = tracked.filter(p => p.converted === 'yes').length;
    
    document.getElementById('tSent').innerText = tracked.length;
    document.getElementById('tConverted').innerText = converted;
    document.getElementById('tRate').innerText = tracked.length ? Math.round(converted/tracked.length*100)+'%' : '0%';
    
    // ØªÙ‚Ø§Ø±ÙŠØ±
    document.getElementById('rSent').innerText = tracked.length;
    document.getElementById('rConverted').innerText = converted;
    document.getElementById('rRate').innerText = tracked.length ? Math.round(converted/tracked.length*100)+'%' : '0%';

    grid.innerHTML = tracked.map(p => `
        <div class="track-card ${p.converted === 'yes' ? 'converted' : ''}">
            <div class="name">${p.name||'Guest'}</div>
            <div class="phone">${p.phone}</div>
            <div class="med">${p.med}</div>
            ${p.converted === 'yes' 
                ? '<button class="track-btn done">âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>' 
                : `<button class="track-btn" onclick="PatientActions.markConverted('${p.id}')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>`}
        </div>
    `).join('');
}

function updateStats(s) {
    if(s) {
        document.getElementById('total').innerText = s.total;
        document.getElementById('warn').innerText = s.warn;
        document.getElementById('over').innerText = s.over;
        document.getElementById('pendingOrders').innerText = s.orders;
    }
}

function setEntryType(t) {
    document.getElementById('entryType').value = t;
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.type-btn.${t}`).classList.add('active');
    document.getElementById('refillFields').style.display = t === 'refill' ? 'block' : 'none';
    document.getElementById('orderFields').style.display = t === 'order' ? 'block' : 'none';
}

function resetForm() {
    document.getElementById('patientForm').reset();
    document.getElementById('editId').value = '';
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('submitBtn').innerHTML = '<span>â•</span> Ø­ÙØ¸';
    document.getElementById('formTitle').innerText = 'â• Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯';
    setEntryType('refill');
}

function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(page+'Page').classList.add('active');
    document.querySelector(`[data-page="${page}"]`).classList.add('active');
    if(page === 'patients') renderPatients();
}

const UI = {
    setLoading(s) { document.getElementById('loadingOverlay').classList.toggle('active', s) },
    showToast(m) {
        const t = document.createElement('div'); t.className = 'toast toast-success'; t.innerText = m;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
};
</script>
</body>
</html>
