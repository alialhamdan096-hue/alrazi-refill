<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alrazi Pharmacy System</title>
    <style>
        :root{--primary:#561C2C;--accent:#8DC63F;--bg:#f4f4f9;--text:#333;--danger:#ef4444;--wa:#25D366;}
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);margin:0;padding:20px;color:var(--text)}
        .container{max-width:800px;margin:0 auto}
        .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);margin-bottom:20px}
        h1{color:var(--primary);text-align:center;margin-bottom:20px}
        
        /* Form Elements */
        input,select,button{width:100%;padding:12px;margin:6px 0;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box}
        input:focus,select:focus{outline:none;border-color:var(--primary)}
        
        /* Buttons */
        button{cursor:pointer;font-weight:bold;color:#fff;background:var(--primary);border:none;transition:0.2s}
        button:hover{opacity:0.9;transform:translateY(-1px)}
        .nav{display:flex;gap:10px;justify-content:center;margin-bottom:20px}
        .nav button{flex:1;background:var(--primary);opacity:0.8}
        .nav button.active{opacity:1;box-shadow:0 2px 8px rgba(86,28,44,0.3)}
        
        /* Action Buttons */
        .actions{display:flex;gap:5px;justify-content:flex-end}
        .actions button{width:36px;height:36px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:6px}
        .btn-wa{background:var(--wa)!important}
        .btn-edit{background:#f3f4f6!important;color:#333!important}
        .btn-del{background:var(--danger)!important}
        
        /* Table */
        .table-wrap{overflow-x:auto}
        table{width:100%;border-collapse:collapse;margin-top:10px;min-width:600px}
        th{text-align:left;padding:12px;background:#f8f9fa;color:#666;font-size:13px;border-bottom:2px solid #eee}
        td{padding:12px;border-bottom:1px solid #eee;vertical-align:middle}
        
        /* Badges */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:bold;display:inline-block}
        .b-ok{background:rgba(141,198,63,0.15);color:#4a7a16}
        .b-bad{background:rgba(239,68,68,0.15);color:#b91c1c}
        .b-ord{background:rgba(59,130,246,0.15);color:#1e40af}
        
        /* Utils */
        .hidden{display:none}
        #loader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:99;flex-direction:column}
        .spinner{width:40px;height:40px;border:4px solid #eee;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>

<script>
    // ‚úÖ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ™ŸÖ ÿØŸÖÿ¨Ÿá ÿ®ŸÜÿ¨ÿßÿ≠
    const API_URL = "https://script.google.com/macros/s/AKfycbykcl1v2TEURnPasMiMbJFCmnC6MgGfhHCAGmwOM6vu_sxpt7CdFM6NcDCRDxrGPVlo/exec"; 
</script>

<div id="loader"><div class="spinner"></div><p style="margin-top:10px;color:var(--primary)">Processing...</p></div>

<div class="container">
    <h1>Rass 1 Pharmacy üíä</h1>
    
    <div class="nav">
        <button onclick="Show('list')" id="nav-list" class="active">üìã Patients</button>
        <button onclick="Show('add')" id="nav-add">‚ûï Add New</button>
    </div>

    <div id="view-add" class="card hidden">
        <h3 style="margin-top:0">‚ûï New Entry</h3>
        <form onsubmit="Save(event)">
            <input type="hidden" id="id">
            <label style="font-size:12px;font-weight:bold">Type</label>
            <select id="type" onchange="ToggleType()">
                <option value="refill">Refill (Monthly Patient)</option>
                <option value="order">Special Order</option>
            </select>
            
            <label style="font-size:12px;font-weight:bold">Phone</label>
            <input type="tel" id="phone" placeholder="05xxxxxxxx" required>
            
            <label style="font-size:12px;font-weight:bold">Details</label>
            <input type="text" id="name" placeholder="Patient Name">
            <input type="text" id="med" placeholder="Medication Name" required>
            
            <div id="refill-opts">
                <label style="font-size:12px;font-weight:bold">Last Dispense Date</label>
                <input type="date" id="date">
            </div>
            
            <div id="order-opts" class="hidden">
                <label style="font-size:12px;font-weight:bold">Source Branch</label>
                <input type="text" id="branch" placeholder="e.g. Unizah 1">
            </div>
            
            <input type="text" id="notes" placeholder="Notes (Optional)">
            <button type="submit" style="margin-top:10px">üíæ Save Record</button>
        </form>
    </div>

    <div id="view-list" class="card">
        <input type="text" id="search" placeholder="üîç Search name, phone or med..." onkeyup="Render()">
        <div class="table-wrap">
            <table id="table">
                <thead><tr><th>Patient</th><th>Medication</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let data = [];
const today = new Date();
const WA_ICON = `<svg viewBox="0 0 32 32" width="18" height="18" fill="white"><path d="M16,2A13,13,0,0,0,4.9,22.2L2,30l7.8-2.9A13,13,0,1,0,16,2z M22.7,21.7c-0.3,0.8-1.5,1.5-2.1,1.5c-0.6,0-2.3-0.7-5.4-3.6c-2.4-2.3-3.8-4.5-4.1-5.1s0-1,0.6-1.6c0.3-0.3,0.5-0.5,0.7-0.8c0.2-0.2,0.1-0.5,0-0.7s-1.2-3-1.6-4.1c-0.4-1.1-0.9-0.9-1.2-0.9H9.1c-0.4,0-1,0.2-1.6,0.8c-0.6,0.6-2.2,2.2-2.2,5.3s2.3,6.1,2.6,6.5c0.3,0.4,4.4,6.7,10.7,9.4c3.7,1.6,5.2,1.6,6.1,1.5c1-0.1,2.7-1.1,3.1-2.2C28.1,22.9,28.1,22.1,27.8,22C27.5,21.9,26,21.1,25.4,20.8C24.8,20.5,24.4,20.3,24.2,20.6C24,21,23.3,21.9,22.7,21.7z"/></svg>`;

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date').valueAsDate = new Date();
    LoadData();
});

async function LoadData() {
    document.getElementById('loader').style.display = 'flex';
    try {
        const local = localStorage.getItem('rass_data');
        if(local) { data = JSON.parse(local); Render(); }
        
        if(API_URL.includes("http")) {
            const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'get'})});
            data = await res.json();
            localStorage.setItem('rass_data', JSON.stringify(data));
            Render();
        }
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display = 'none';
}

async function Save(e) {
    e.preventDefault();
    document.getElementById('loader').style.display = 'flex';
    
    const item = {
        id: document.getElementById('id').value || Date.now().toString(),
        type: document.getElementById('type').value,
        phone: document.getElementById('phone').value,
        name: document.getElementById('name').value,
        med: document.getElementById('med').value,
        date: document.getElementById('date').value,
        branch: document.getElementById('branch').value,
        notes: document.getElementById('notes').value
    };

    const idx = data.findIndex(x => x.id == item.id);
    if(idx > -1) data[idx] = item; else data.push(item);
    
    Render();
    Show('list');
    document.getElementById('id').value = '';
    document.forms[0].reset();
    document.getElementById('date').valueAsDate = new Date();

    if(API_URL.includes("http")) {
        await fetch(API_URL, {method:'POST', body:JSON.stringify({action: idx>-1?'update':'add', data:item})});
    }
    document.getElementById('loader').style.display = 'none';
}

async function Del(id) {
    if(!confirm('Delete this record?')) return;
    data = data.filter(x => x.id != id);
    Render();
    localStorage.setItem('rass_data', JSON.stringify(data));
    if(API_URL.includes("http")) {
        await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', data:{id}})});
    }
}

function Render() {
    const q = document.getElementById('search').value.toLowerCase();
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    
    data.filter(x => (x.name+x.phone+x.med).toLowerCase().includes(q))
    .sort((a,b) => new Date(a.date||'2099') - new Date(b.date||'2099'))
    .forEach(x => {
        let status = '', dueStr = '';
        if(x.type === 'refill') {
            const next = new Date(new Date(x.date).getTime() + 30*86400000);
            const diff = Math.ceil((next - today)/(86400000));
            dueStr = next.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            status = diff < 0 ? `<span class="badge b-bad">${Math.abs(diff)}d Over</span>` : `<span class="badge b-ok">${diff}d Left</span>`;
        } else {
            status = `<span class="badge b-ord">Order</span>`;
            dueStr = x.branch || 'Pending';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="font-weight:bold">${x.name || 'Unknown'}</div>
                <div style="font-size:12px;color:#888">${x.phone}</div>
            </td>
            <td>
                <div style="font-weight:500;color:var(--primary)">${x.med}</div>
                <div style="font-size:11px;color:#666">${x.notes||''}</div>
            </td>
            <td>
                <div style="font-size:12px;margin-bottom:2px">${dueStr}</div>
                ${status}
            </td>
            <td>
                <div class="actions">
                    <button class="btn-wa" onclick="WA('${x.phone}', '${x.med}')" title="WhatsApp">${WA_ICON}</button>
                    <button class="btn-edit" onclick="Edit('${x.id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-del" onclick="Del('${x.id}')" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function WA(phone, med) {
    let p = phone.replace(/\D/g,'');
    if(!p.startsWith('966')) p = '966' + p.replace(/^0/,'');
    const msg = `ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ÿµŸäÿØŸÑŸäÿ© ÿßŸÑÿ±ÿßÿ≤Ÿä ÿ™ÿ∞ŸÉÿ±ŸÉŸÖ ÿ®ŸÖŸàÿπÿØ ÿµÿ±ŸÅ ÿßŸÑÿπŸÑÿßÿ¨: ${med}`;
    window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`);
}

function Edit(id) {
    const x = data.find(i => i.id == id);
    for(let k in x) if(document.getElementById(k)) document.getElementById(k).value = x[k];
    Show('add');
}

function Show(v) {
    document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('view-'+v).classList.remove('hidden');
    document.getElementById('nav-'+v).classList.add('active');
}

function ToggleType() {
    const t = document.getElementById('type').value;
    document.getElementById('refill-opts').classList.toggle('hidden', t !== 'refill');
    document.getElementById('order-opts').classList.toggle('hidden', t !== 'order');
}
</script>
</body>
</html>
