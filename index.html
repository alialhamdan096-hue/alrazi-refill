<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alrazi Refill Cash Patients System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: white; color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #14b8a6; margin-bottom: 10px; text-align: center; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .tab { background: #f0f0f0; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; }
        .tab.active { background: #14b8a6; color: white; }
        .tab:hover { opacity: 0.9; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #f8f9fa; border-radius: 15px; padding: 25px; border: 1px solid #dee2e6; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #495057; font-size: 14px; }
        input, select { width: 100%; padding: 12px; background: white; border: 1px solid #ced4da; border-radius: 8px; color: #495057; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #14b8a6; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-primary { background: #14b8a6; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #495057; font-size: 12px; text-transform: uppercase; }
        td { padding: 15px 12px; border-bottom: 1px solid #dee2e6; }
        .name { font-weight: bold; }
        .phone { color: #6c757d; font-size: 13px; }
        .med { color: #14b8a6; }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-ok { background: rgba(16,185,129,0.2); color: #10b981; }
        .badge-warn { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .badge-danger { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .actions { display: flex; gap: 8px; }
        .actions button { width: 35px; height: 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .wa { background: rgba(37,211,102,0.2); color: #25D366; }
        .edit { background: rgba(20,184,166,0.2); color: #14b8a6; }
        .del { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat { background: white; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; }
        .stat-num { font-size: 32px; font-weight: bold; }
        .stat-label { color: #6c757d; font-size: 14px; }
        
        .sync { text-align: center; padding: 8px; font-size: 13px; margin-bottom: 15px; border-radius: 8px; }
        .sync-ok { background: rgba(16,185,129,0.1); color: #10b981; }

        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .track-card { background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; }
        .track-card.converted { border-color: #10b981; background: rgba(16,185,129,0.05); }
        
        .track-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: rgba(16,185,129,0.15); color: #10b981; margin-top: 10px; transition: 0.2s; }
        .track-btn:hover { background: rgba(16,185,129,0.25); }
        
        .converted-label {
            margin-top: 10px; 
            color: #10b981; 
            font-weight: bold; 
            padding: 10px; 
            background: rgba(16,185,129,0.1); 
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(16,185,129,0.2);
        }

        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .report-card { background: #f8f9fa; border-radius: 12px; padding: 25px; border: 1px solid #dee2e6; text-align: center; }
        .report-value { font-size: 48px; font-weight: bold; color: #14b8a6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Alrazi Refill Cash Patients System</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showPage('patients')">üìã Patients</button>
            <button class="tab" onclick="showPage('tracking')">üìä Tracking</button>
            <button class="tab" onclick="showPage('reports')">üìà Reports</button>
        </div>
        
        <div id="sync" class="sync sync-ok">‚úì Connected to Google Sheets</div>

        <div id="patientsPage" class="page active">
            <div class="stats">
                <div class="stat"><div class="stat-num" id="total">0</div><div class="stat-label">Total Patients</div></div>
                <div class="stat"><div class="stat-num" id="warn" style="color:#f59e0b">0</div><div class="stat-label">Need Reminder</div></div>
                <div class="stat"><div class="stat-num" id="over" style="color:#ef4444">0</div><div class="stat-label">Overdue</div></div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom:20px" id="formTitle">Add Patient</h3>
                    <form id="form">
                        <input type="hidden" id="pid">
                        <div class="form-group"><label>Patient Name</label><input type="text" id="name" required></div>
                        <div class="form-group"><label>Phone (e.g. 966512345678)</label><input type="tel" id="phone" required></div>
                        <div class="form-group"><label>Medication</label><input type="text" id="med" required></div>
                        <div class="row">
                            <div class="form-group"><label>Dispense Date</label><input type="date" id="date" required></div>
                            <div class="form-group"><label>Duration (days)</label><input type="number" id="days" value="30" required></div>
                        </div>
                        <div class="form-group"><label>Notes</label><input type="text" id="notes"></div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Add Patient</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                    </form>
                </div>

                <div class="card">
                    <input type="text" id="search" placeholder="üîç Search patients..." oninput="renderPatients()" style="margin-bottom: 15px;">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Patient</th><th>Medication</th><th>Refill Date</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="patientsTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="trackingPage" class="page">
            <div class="card">
                <div class="track-grid" id="trackGrid"></div>
            </div>
        </div>

        <div id="reportsPage" class="page">
            <div class="report-grid">
                <div class="report-card"><div class="report-value" id="rSent">0</div><div class="report-label">Reminders Sent</div></div>
                <div class="report-card"><div class="report-value" id="rConverted">0</div><div class="report-label">Converted</div></div>
                <div class="report-card"><div class="report-value" id="rRate">0%</div><div class="report-label">Conversion Rate</div></div>
            </div>
        </div>
    </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyLnOK9PXLM7Z6_ERgT84nul50S62juQ7h8AYywUUJ0eUUn1GaG_0LOjkY7HLw9S7wYkQ/exec';
let patients = [];
let editId = null;

function fmtDate(v) {
    if (!v) return '';
    if (typeof v === 'string' && v.includes('T')) {
        const d = new Date(v);
        return d.toLocaleDateString('en-CA');
    }
    if (typeof v === 'string') return v;
    const d = new Date(v);
    if (isNaN(d)) return '';
    return d.toLocaleDateString('en-CA');
}

document.getElementById('date').value = fmtDate(new Date());

async function loadData() {
    try {
        const res = await fetch(API + '?action=get');
        const data = await res.json();
        patients = data.map(p => ({
            ...p,
            id: String(p.id),
            date: fmtDate(p.date),
            reminderDate: fmtDate(p.reminderDate),
            convertedDate: fmtDate(p.convertedDate)
        }));
        renderPatients();
        renderReports();
    } catch (e) {
        console.error("Error loading data");
    }
}

loadData();

function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.getElementById(p + 'Page').classList.add('active');
    if (p === 'tracking') renderTracking();
    if (p === 'reports') renderReports();
}

document.getElementById('form').onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    
    const p = {
        id: editId || Date.now().toString(),
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value.replace(/\D/g, ''),
        med: document.getElementById('med').value,
        date: document.getElementById('date').value, 
        days: document.getElementById('days').value,
        notes: document.getElementById('notes').value,
        reminderSent: 'no', reminderDate: '', converted: 'no', convertedDate: ''
    };
    
    if (editId) {
        const old = patients.find(x => x.id === editId);
        p.reminderSent = old.reminderSent; p.reminderDate = old.reminderDate;
        p.converted = old.converted; p.convertedDate = old.convertedDate;
    }
    
    try {
        await fetch(API + '?action=' + (editId ? 'update' : 'add') + '&data=' + encodeURIComponent(JSON.stringify(p)));
        if (editId) patients[patients.findIndex(x => x.id === editId)] = p;
        else patients.push(p);
        renderPatients();
        renderReports(); 
        resetForm();
    } catch (e) {
        alert("Error saving data");
    }
    btn.disabled = false;
};

function editP(id) {
    const p = patients.find(x => x.id === id);
    editId = id;
    document.getElementById('name').value = p.name;
    document.getElementById('phone').value = p.phone;
    document.getElementById('med').value = p.med;
    document.getElementById('date').value = p.date;
    document.getElementById('days').value = p.days;
    document.getElementById('notes').value = p.notes || '';
    document.getElementById('formTitle').textContent = 'Edit Patient';
    document.getElementById('submitBtn').textContent = 'Update';
}

async function delP(id) {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ±Ÿäÿ∂ÿü')) return;
    patients = patients.filter(x => x.id !== id);
    renderPatients();
    renderReports(); 
    try { await fetch(API + '?action=delete&id=' + id); } catch (e) {}
}

function resetForm() {
    editId = null;
    document.getElementById('form').reset();
    document.getElementById('date').value = fmtDate(new Date());
    document.getElementById('formTitle').textContent = 'Add Patient';
}

function getRefill(p) {
    const d = new Date(p.date);
    d.setDate(d.getDate() + parseInt(p.days));
    return d;
}

function getDays(p) {
    const today = new Date(); today.setHours(0,0,0,0);
    const refill = getRefill(p); refill.setHours(0,0,0,0);
    return Math.ceil((refill - today) / (1000*60*60*24));
}

function renderPatients() {
    const search = document.getElementById('search').value.toLowerCase();
    const list = patients.filter(p => p.name.toLowerCase().includes(search));
    const tbody = document.getElementById('patientsTbody');
    
    tbody.innerHTML = list.map(p => {
        const d = getDays(p);
        const refillStr = fmtDate(getRefill(p));
        const sc = d < 0 ? 'danger' : (d <= 2 ? 'warn' : 'ok');
        return `<tr>
            <td><div class="name">${p.name}</div><div class="phone">${p.phone}</div></td>
            <td>${p.med}</td>
            <td>${refillStr}</td>
            <td><span class="badge badge-${sc}">${d}d left</span></td>
            <td><div class="actions">
                <button class="wa" onclick="sendWA('${p.id}')">üì±</button>
                <button class="edit" onclick="editP('${p.id}')">‚úèÔ∏è</button>
                <button class="del" onclick="delP('${p.id}')">üóëÔ∏è</button>
            </div></td>
        </tr>`;
    }).join('');
}

async function sendWA(id) {
    const p = patients.find(x => x.id === id);
    const msg = `ÿ™ÿ∞ŸÉŸäÿ± ÿ®ŸÖŸàÿπÿØ ÿµÿ±ŸÅ ÿØŸàÿßÿ°: ${p.med}`;
    window.open('https://wa.me/' + p.phone + '?text=' + encodeURIComponent(msg), '_blank');
    p.reminderSent = 'yes';
    p.reminderDate = fmtDate(new Date()); 
    await fetch(API + '?action=update&data=' + encodeURIComponent(JSON.stringify(p)));
    renderTracking();
    renderReports();
}

async function markConverted(id) {
    const p = patients.find(x => x.id === id);
    p.converted = 'yes';
    p.convertedDate = fmtDate(new Date());
    await fetch(API + '?action=update&data=' + encodeURIComponent(JSON.stringify(p)));
    renderTracking();
    renderReports(); 
}

function renderTracking() {
    const grid = document.getElementById('trackGrid');
    const list = patients.filter(p => p.reminderSent === 'yes');
    grid.innerHTML = list.map(p => `
        <div class="track-card ${p.converted === 'yes' ? 'converted' : ''}">
            <div>${p.name}</div>
            <div class="phone">Sent: ${p.reminderDate}</div>
            ${p.converted === 'yes' 
                ? `<div class="converted-label">‚úÖ Converted</div>`
                : `<button class="track-btn" onclick="markConverted('${p.id}')">‚úÖ Mark Converted</button>`
            }
        </div>
    `).join('');
}

function renderReports() {
    const sent = patients.filter(p => p.reminderSent === 'yes').length;
    const conv = patients.filter(p => p.converted === 'yes').length;
    const rate = sent > 0 ? Math.round((conv / sent) * 100) : 0;

    document.getElementById('rSent').textContent = sent;
    document.getElementById('rConverted').textContent = conv;
    document.getElementById('rRate').textContent = rate + '%';
}
</script>
</body>
</html>
